<!DOCTYPE html>
<html lang="en" class="h-full bg-slate-100">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Slink Admin Dashboard</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
      body {
        font-family: "Inter", sans-serif;
        -webkit-font-smoothing: antialiased;
      }
      .scrollbar-thin::-webkit-scrollbar {
        width: 6px;
      }
      .scrollbar-thin::-webkit-scrollbar-thumb {
        background-color: rgba(148, 163, 184, 0.5);
        border-radius: 9999px;
      }

      /* Athena-inspired styles */
      .athena-sidebar {
        background-color: #f8fafc;
        border-right: 1px solid #e2e8f0;
        transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      }
      .athena-nav-item {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        padding: 0.625rem 1rem;
        border-radius: 0.75rem;
        font-size: 0.875rem;
        font-weight: 500;
        color: #64748b;
        transition: all 0.2s ease;
      }
      .athena-nav-item:hover {
        background-color: #f1f5f9;
        color: #0f172a;
      }
      .athena-nav-item.active {
        background-color: #fff;
        color: #0f172a;
        box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        border: 1px solid #e2e8f0;
      }
      .athena-card {
        background: white;
        border-radius: 1rem;
        border: 1px solid #f1f5f9;
        padding: 1.5rem;
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05);
      }
      .athena-gradient-card {
        background: linear-gradient(135deg, #fff5f7 0%, #f0f4ff 100%);
        border-radius: 1rem;
        padding: 1.5rem;
        display: flex;
        flex-direction: column;
        gap: 1.5rem;
      }
      @media (min-width: 640px) {
        .athena-gradient-card {
          flex-direction: row;
          justify-content: space-between;
          align-items: center;
        }
      }
      .athena-table th {
        background-color: #f8fafc;
        color: #64748b;
        font-weight: 600;
        text-transform: uppercase;
        font-size: 0.75rem;
        letter-spacing: 0.05em;
        padding: 0.75rem 1.5rem;
      }
      .athena-table td {
        padding: 1rem 1.5rem;
        border-bottom: 1px solid #f1f5f9;
      }
      .athena-status-pill {
        padding: 0.25rem 0.75rem;
        border-radius: 9999px;
        font-size: 0.75rem;
        font-weight: 600;
        display: inline-flex;
        align-items: center;
        justify-content: center;
      }
      .status-completed { background-color: #dcfce7; color: #166534; }
      .status-pending { background-color: #fef9c3; color: #854d0e; }
      .status-overdue { background-color: #fee2e2; color: #991b1b; }

      /* Mature Table Responsiveness */
      @media (max-width: 1023px) {
        .athena-table thead {
          display: none;
        }
        .athena-table, .athena-table tbody, .athena-table tr {
          display: block;
          width: 100%;
        }
        .athena-table tr {
          margin-bottom: 1rem;
          border: 1px solid #f1f5f9;
          border-radius: 1rem;
          padding: 1rem;
          background: white;
          box-shadow: 0 1px 2px rgba(0,0,0,0.05);
        }
        .athena-table td {
          display: flex;
          justify-content: space-between;
          align-items: center;
          padding: 0.5rem 0;
          border-bottom: 1px solid #f8fafc;
          text-align: right;
        }
        .athena-table td:last-child {
          border-bottom: none;
          padding-top: 1rem;
        }
        .athena-table td::before {
          content: attr(data-label);
          font-weight: 600;
          font-size: 0.75rem;
          color: #64748b;
          text-transform: uppercase;
          text-align: left;
          flex: 1;
        }
        .athena-table td > * {
          flex: 1;
          display: flex;
          justify-content: flex-end;
        }
        /* Special handling for certain columns */
        .athena-table td[data-label="Registrant"] {
          flex-direction: column;
          align-items: flex-start;
          text-align: left;
        }
        .athena-table td[data-label="Registrant"]::before {
          margin-bottom: 0.5rem;
        }
        .athena-table td[data-label="Registrant"] > div {
          justify-content: flex-start;
          width: 100%;
        }
      }

      .summary-card {
        position: relative;
        overflow: hidden;
        padding: 1.5rem;
        border-radius: 1rem;
        border: 1px solid #f1f5f9;
        background: white;
        box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        cursor: pointer;
        transition: all 0.2s ease;
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
      }

      .summary-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
      }

      .summary-card.summary-card--active {
        border-color: #6366f1;
        outline: 2px solid #6366f1;
        background-color: #f5f7ff;
      }

      .summary-card-label {
        font-size: 0.875rem;
        font-weight: 500;
        color: #64748b;
      }

      .summary-card-value {
        font-size: 1.875rem;
        font-weight: 700;
        color: #0f172a;
      }

      .summary-card-icon {
        width: 2.5rem;
        height: 2.5rem;
        border-radius: 0.5rem;
        display: flex;
        align-items: center;
        justify-content: center;
        margin-bottom: 0.5rem;
      }

      /* Mobile Header */
      .mobile-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 1rem 1.5rem;
        background: white;
        border-bottom: 1px solid #e2e8f0;
        position: sticky;
        top: 0;
        z-index: 50;
      }
      @media (min-width: 1024px) {
        .mobile-header {
          display: none;
        }
      }

      #sidebar-overlay {
        background-color: rgba(15, 23, 42, 0.5);
        backdrop-filter: blur(4px);
        transition: opacity 0.3s ease;
      }
    </style>
  </head>
  <body class="h-full text-slate-700 bg-slate-50">
    <div class="relative flex min-h-screen bg-white flex-col lg:flex-row">
      <!-- Mobile Header -->
      <header class="mobile-header w-full lg:hidden bg-white">
        <div class="flex items-center gap-3">
          <img src="img/slink.png" alt="Slink Logo" class="h-8 w-auto flex-shrink-0" />
          <span class="text-xl font-bold text-slate-900 tracking-tight">Slink.</span>
        </div>
        <button id="mobile-nav-open" class="p-2 text-slate-600 hover:bg-slate-100 rounded-lg transition">
          <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16m-7 6h7"/></svg>
        </button>
      </header>

      <!-- Sidebar Overlay -->
      <div id="sidebar-overlay" class="fixed inset-0 z-40 lg:hidden hidden"></div>

      <!-- Sidebar -->
      <aside
        id="sidebar"
        class="fixed inset-y-0 left-0 z-50 w-72 athena-sidebar transform -translate-x-full transition-transform duration-300 ease-in-out lg:translate-x-0 lg:static lg:flex lg:flex-col lg:min-h-screen"
      >
        <div class="p-6 flex items-center justify-between">
          <div class="flex items-center gap-3">
            <img src="img/slink.png" alt="Slink Logo" class="h-8 w-auto" />
            <span class="text-xl font-bold text-slate-900 tracking-tight">Slink.</span>
          </div>
          <button id="mobile-nav-close" class="lg:hidden p-2 text-slate-400 hover:text-slate-600 transition">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
          </button>
        </div>

        <div class="px-4 py-2">
          <div class="relative">
            <input type="text" id="search-input" placeholder="Search clients..." class="w-full bg-slate-100 border-none rounded-lg py-2.5 pl-10 pr-4 text-sm focus:ring-2 focus:ring-indigo-500 transition-all" />
            <svg class="w-4 h-4 text-slate-400 absolute left-3 top-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/></svg>
          </div>
        </div>

        <nav class="flex-1 px-4 py-6 space-y-1 overflow-y-auto scrollbar-thin">
          <p class="px-3 text-xs font-semibold text-slate-400 uppercase tracking-wider mb-2">Menu</p>
          <button class="athena-nav-item w-full active" data-filter="registered">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"/></svg>
            <span>Dashboard</span>
            <span class="ml-auto bg-slate-200 text-slate-600 px-2 py-0.5 rounded-full text-xs font-bold" data-badge-count="registered">0</span>
          </button>
          <button class="athena-nav-item w-full" data-filter="new-skill">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
            <span>New Skill</span>
            <span class="ml-auto bg-slate-200 text-slate-600 px-2 py-0.5 rounded-full text-xs font-bold" data-badge-count="newSkill">0</span>
          </button>
          <button class="athena-nav-item w-full" data-filter="pending-skill">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"/></svg>
            <span>Pending</span>
            <span class="ml-auto bg-slate-200 text-slate-600 px-2 py-0.5 rounded-full text-xs font-bold" data-badge-count="pending">0</span>
          </button>
          <button class="athena-nav-item w-full" data-filter="connected-skill">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/></svg>
            <span>Connected</span>
            <span class="ml-auto bg-slate-200 text-slate-600 px-2 py-0.5 rounded-full text-xs font-bold" data-badge-count="connected">0</span>
          </button>
          <button class="athena-nav-item w-full" data-filter="mailed">
             <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/></svg>
             <span>Mailed</span>
             <span class="ml-auto bg-slate-200 text-slate-600 px-2 py-0.5 rounded-full text-xs font-bold" data-badge-count="mailed">0</span>
          </button>
        </nav>

        <div class="p-4 mt-auto">
          <div class="bg-indigo-600 rounded-2xl p-5 text-white shadow-lg shadow-indigo-200">
            <p class="text-[10px] font-bold uppercase tracking-wider opacity-80">Intelligence Insights</p>
            <p class="text-sm mt-2 leading-relaxed">Real-time monitoring of your skill lifecycle.</p>
          </div>
          <div class="mt-6 flex items-center gap-3 px-2 border-t border-slate-200 pt-6">
            <div class="w-10 h-10 rounded-full bg-slate-200 overflow-hidden ring-2 ring-white">
                <img src="https://ui-avatars.com/api/?name=Admin+User&background=6366f1&color=fff" alt="User" />
            </div>
            <div class="flex-1 min-w-0">
                <p class="text-sm font-bold text-slate-900 truncate">Admin User</p>
                <p class="text-xs text-slate-500 truncate">admin@slink.com</p>
            </div>
          </div>
        </div>
      </aside>

      <!-- Main Content -->
      <main class="flex-1 bg-white overflow-y-auto scrollbar-thin min-h-screen lg:min-h-0">
        <div class="max-w-7xl mx-auto p-4 sm:p-6 lg:p-8">
          <header class="flex flex-col sm:flex-row sm:justify-between sm:items-center gap-6 mb-10">
            <div>
              <h1 class="text-2xl sm:text-3xl font-bold text-slate-900 tracking-tight">Invoices & Registrations</h1>
              <p class="text-slate-500 mt-1.5 text-sm sm:text-base">Explore your full registration history and transaction data.</p>
            </div>
            <div class="flex flex-wrap items-center gap-3">
                <button id="reset-filters" class="flex-1 sm:flex-none px-5 py-2.5 border border-slate-200 rounded-xl text-sm font-semibold text-slate-700 hover:bg-slate-50 transition-all">Reset Filters</button>
                <button class="flex-1 sm:flex-none px-5 py-2.5 bg-slate-900 text-white rounded-xl text-sm font-semibold hover:bg-slate-800 transition-all flex items-center justify-center gap-2 shadow-sm">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"/></svg>
                    Create Registration
                </button>
            </div>
          </header>

          <!-- Summary Stats -->
          <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 sm:gap-6 mb-10">
            <div class="summary-card" data-summary-card="registered">
                <div class="summary-card-icon bg-indigo-50 text-indigo-600">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"/></svg>
                </div>
                <span class="summary-card-label">Total Registrations</span>
                <span class="summary-card-value" data-summary-value>0</span>
            </div>
            <div class="summary-card" data-summary-card="newSkill">
                <div class="summary-card-icon bg-sky-50 text-sky-600">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/></svg>
                </div>
                <span class="summary-card-label">New Skills</span>
                <span class="summary-card-value" data-summary-value>0</span>
            </div>
            <div class="summary-card" data-summary-card="connected">
                <div class="summary-card-icon bg-emerald-50 text-emerald-600">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
                </div>
                <span class="summary-card-label">Connected</span>
                <span class="summary-card-value" data-summary-value>0</span>
            </div>
            <div class="summary-card" data-summary-card="pending">
                <div class="summary-card-icon bg-amber-50 text-amber-600">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
                </div>
                <span class="summary-card-label">Pending Review</span>
                <span class="summary-card-value" data-summary-value>0</span>
            </div>
          </div>

          <!-- Table Section -->
          <div class="athena-card">
            <div class="flex flex-col md:flex-row justify-between md:items-center gap-6 mb-8">
                <div class="flex-1">
                    <h3 class="text-xl font-bold text-slate-900 tracking-tight">Registration Lists</h3>
                    <p class="text-sm text-slate-500 mt-0.5">Registration history for the past 30 days</p>
                </div>
                <div class="flex flex-col sm:flex-row items-stretch sm:items-center gap-4">
                    <div class="relative flex-1 sm:w-80">
                        <input type="text" id="header-search-input" placeholder="Search client or skill..." class="w-full bg-slate-50 border border-slate-200 rounded-xl py-2.5 pl-10 pr-4 text-sm focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition-all shadow-sm" />
                        <svg class="w-4 h-4 text-slate-400 absolute left-3 top-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/></svg>
                    </div>
                    <div class="flex items-center justify-between sm:justify-start gap-3 bg-slate-50/50 px-3 py-2 rounded-xl border border-slate-100">
                        <div class="flex items-center gap-2">
                            <span class="w-2 h-2 rounded-full bg-emerald-500 animate-pulse"></span>
                            <span class="text-[10px] font-bold text-emerald-600 uppercase tracking-widest">Sync Active</span>
                        </div>
                    </div>
                </div>
            </div>

            <div class="overflow-x-auto lg:-mx-6 lg:px-6">
                <table class="w-full athena-table" id="people-table">
                    <thead>
                        <tr>
                            <th class="text-left w-12"><input type="checkbox" class="rounded text-indigo-600 focus:ring-indigo-500" /></th>
                            <th class="text-left">Registrant</th>
                            <th class="text-left">Skills Matrix</th>
                            <th class="text-left">Status</th>
                            <th class="text-left">Readiness</th>
                            <th class="text-right">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="table-body">
                        <!-- populated dynamically -->
                    </tbody>
                </table>
            </div>
          </div>

          <!-- Mailed Section (Hidden unless filtered) -->
          <div id="mailed-section" class="athena-card mt-10 hidden">
            <div class="mb-8">
                <h3 class="text-xl font-bold text-slate-900 tracking-tight">Assessment Mail Queue</h3>
                <p class="text-sm text-slate-500 mt-0.5">Candidates currently in the automated assessment pipeline.</p>
            </div>
            <div id="mailed-list" class="divide-y divide-slate-100">
                <!-- populated dynamically -->
            </div>
            <div id="mailed-empty" class="py-20 text-center flex flex-col items-center gap-4">
                <div class="w-16 h-16 bg-slate-50 rounded-full flex items-center justify-center text-slate-300">
                  <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/></svg>
                </div>
                <p class="text-slate-400 font-medium">No candidates mailed yet.</p>
            </div>
          </div>
        </div>
      </main>
    </div>

    <div
      id="person-detail"
      class="fixed inset-0 z-50 hidden"
      aria-modal="true"
      role="dialog"
    >
      <div
        id="detail-overlay"
        class="absolute inset-0 bg-slate-900/40 opacity-0 transition-opacity duration-300"
        data-close-detail
      ></div>
      <aside
        id="detail-panel"
        class="absolute inset-y-0 right-0 flex h-full w-full max-w-xl translate-x-full transform flex-col bg-white shadow-2xl transition-transform duration-300 md:max-w-lg lg:max-w-xl"
      >
        <header class="flex items-start justify-between border-b border-slate-200 px-6 py-6">
          <div>
            <span
              id="detail-status"
              class="inline-flex items-center gap-2 rounded-full bg-slate-100 px-3 py-1 text-xs font-semibold uppercase tracking-wide text-slate-500"
            ></span>
            <h2 id="detail-name" class="mt-3 text-2xl font-semibold text-slate-900"></h2>
            <div class="mt-2 flex flex-wrap gap-3 text-sm text-slate-500">
              <span id="detail-email" class="flex items-center gap-2"></span>
              <span id="detail-phone" class="flex items-center gap-2"></span>
              <span id="detail-resume-chip" class="flex items-center gap-2"></span>
              <span id="detail-location" class="flex items-center gap-2"></span>
              <span id="detail-created" class="flex items-center gap-2"></span>
            </div>
          </div>
          <button
            id="detail-close"
            class="rounded-full border border-slate-200 bg-white p-2 text-slate-500 transition hover:border-slate-300 hover:text-slate-900"
            aria-label="Close detail panel"
            data-close-detail
          >
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 24 24" fill="none" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M6 18 18 6m0 12L6 6" />
            </svg>
          </button>
        </header>
        <div class="flex-1 space-y-8 overflow-y-auto px-6 py-6">
          <section>
            <h3 class="text-sm font-semibold uppercase tracking-wide text-slate-500">
              Profile
            </h3>
            <dl class="mt-4 space-y-3 text-sm text-slate-600">
              <div class="flex items-start gap-3">
                <dt class="w-32 text-slate-400">Email</dt>
                <dd id="detail-email-value" class="flex-1 break-words"></dd>
              </div>
              <div class="flex items-start gap-3">
                <dt class="w-32 text-slate-400">Phone</dt>
                <dd id="detail-phone-value" class="flex-1 break-words"></dd>
              </div>
              <div class="flex items-start gap-3">
                <dt class="w-32 text-slate-400">Registration ID</dt>
                <dd id="detail-registration-id" class="flex-1 break-words"></dd>
              </div>
              <div class="flex items-start gap-3">
                <dt class="w-32 text-slate-400">Skill Test</dt>
                <dd id="detail-skill-test" class="flex-1 break-words"></dd>
              </div>
              <div class="flex items-start gap-3">
                <dt class="w-32 text-slate-400">Professional</dt>
                <dd id="detail-professional" class="flex-1 break-words"></dd>
              </div>
              <div class="flex items-start gap-3">
                <dt class="w-32 text-slate-400">Location</dt>
                <dd id="detail-location-value" class="flex-1 break-words"></dd>
              </div>
              <div class="flex items-start gap-3">
                <dt class="w-32 text-slate-400">Source</dt>
                <dd id="detail-source" class="flex-1 break-words"></dd>
              </div>
              <div class="flex items-start gap-3">
                <dt class="w-32 text-slate-400">Consent</dt>
                <dd id="detail-consent" class="flex-1 break-words"></dd>
              </div>
            </dl>
          </section>
          <section>
            <h3 class="text-sm font-semibold uppercase tracking-wide text-slate-500">
              Skills to Learn
            </h3>
            <div id="detail-learn-skill" class="mt-4 flex flex-wrap gap-3"></div>
          </section>
          <section>
            <h3 class="text-sm font-semibold uppercase tracking-wide text-slate-500">
              Skills to Teach
            </h3>
            <div id="detail-teach-skills" class="mt-4 flex flex-wrap gap-3"></div>
          </section>
          <section>
            <div class="flex items-center justify-between">
              <h3 class="text-sm font-semibold uppercase tracking-wide text-slate-500">
                Suggested Tutors
              </h3>
              <span id="detail-match-count" class="text-xs font-medium text-slate-400"></span>
            </div>
            <div id="detail-tutor-suggestions" class="mt-4 space-y-3"></div>
          </section>
          <section
            id="detail-selected-tutor"
            class="hidden rounded-2xl border border-slate-200 bg-white/60 px-4 py-4"
          >
            <div class="flex items-start justify-between gap-3">
              <div>
                <p id="detail-selected-tutor-name" class="text-sm font-semibold text-slate-900"></p>
                <p class="text-xs text-slate-400">Selected tutor contact details</p>
              </div>
              <svg
                xmlns="http://www.w3.org/2000/svg"
                class="h-4 w-4 text-emerald-500"
                fill="none"
                viewBox="0 0 24 24"
                stroke="currentColor"
              >
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M4.5 12.75l6 6 9-13.5" />
              </svg>
            </div>
            <dl class="mt-4 space-y-2 text-xs text-slate-600">
              <div class="flex items-start gap-2">
                <dt class="w-16 text-slate-400">Email</dt>
                <dd id="detail-selected-tutor-email" class="flex-1 break-words"></dd>
              </div>
              <div class="flex items-start gap-2">
                <dt class="w-16 text-slate-400">Location</dt>
                <dd id="detail-selected-tutor-location" class="flex-1 break-words"></dd>
              </div>
              <div class="flex items-start gap-2">
                <dt class="w-16 text-slate-400">Phone</dt>
                <dd id="detail-selected-tutor-phone" class="flex-1 break-words"></dd>
              </div>
            </dl>
            <p id="detail-selected-tutor-hint" class="mt-3 text-xs text-slate-400"></p>
          </section>
          <section id="detail-actions" class="border-t border-slate-100 pt-6">
            <div class="flex flex-col gap-3">
              <button
                id="detail-connect"
                class="inline-flex items-center justify-center gap-2 rounded-full bg-slate-900 px-5 py-2.5 text-sm font-semibold text-white shadow-sm transition hover:bg-slate-700 disabled:cursor-not-allowed disabled:bg-slate-200 disabled:text-slate-400"
                disabled
              >
                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M8.25 7.5h7.5m-7.5 4.5h3" />
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M3 5.25a2.25 2.25 0 012.25-2.25h13.5A2.25 2.25 0 0121 5.25v13.5a2.25 2.25 0 01-2.25 2.25H5.25A2.25 2.25 0 013 18.75V5.25Z" />
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M7.5 16.5l3 3 6-7.5" />
                </svg>
                Mark as Connected
              </button>
              <button
                id="detail-decline"
                class="inline-flex items-center justify-center gap-2 rounded-full border border-red-200 bg-red-50 px-5 py-2.5 text-sm font-semibold text-red-600 transition hover:border-red-300 hover:bg-red-100 disabled:cursor-not-allowed disabled:border-slate-100 disabled:bg-slate-50 disabled:text-slate-300"
              >
                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M6 18 18 6m0 12L6 6" />
                </svg>
                <span id="detail-decline-label">Keep Pending</span>
              </button>
            </div>
          </section>
        </div>
      </aside>
    </div>

    <div
      id="notification-root"
      class="pointer-events-none fixed inset-x-0 top-4 z-[70] flex justify-center px-4"
    ></div>


    <div
      id="remove-confirm"
      class="fixed inset-0 z-[65] hidden"
      role="dialog"
      aria-modal="true"
    >
      <div
        id="remove-confirm-overlay"
        class="absolute inset-0 bg-slate-900/40 opacity-0 transition-opacity duration-200"
        data-remove-dismiss
      ></div>
      <div
        id="remove-confirm-dialog"
        class="absolute inset-0 flex items-center justify-center px-4 py-6 opacity-0 transition-opacity duration-200"
      >
        <div class="w-full max-w-md rounded-2xl bg-white p-6 shadow-2xl shadow-slate-900/25">
          <h3 class="text-lg font-semibold text-slate-900">Delete registration</h3>
          <p class="mt-2 text-sm text-slate-600">
            Are you sure you want to remove
            <span id="remove-confirm-label" class="font-semibold text-slate-900"></span>?
            This action will permanently delete their data from the database.
          </p>

          <div class="mt-5 space-y-4">
            <label class="block text-sm font-medium text-slate-500">
              Registration name
              <input
                id="remove-confirm-name"
                type="text"
                readonly
                class="mt-1 w-full rounded-xl border border-slate-200 bg-slate-50 px-3 py-2 text-sm text-slate-600"
              />
            </label>
            <label class="block text-sm font-medium text-slate-500">
              Type the name to confirm deletion
              <input
                id="remove-confirm-input"
                type="text"
                placeholder="Start typing the name exactly"
                autocomplete="off"
                class="mt-1 w-full rounded-xl border border-slate-300 px-3 py-2 text-sm text-slate-700 focus:border-slate-500 focus:outline-none focus:ring-2 focus:ring-slate-200"
              />
            </label>
          </div>

          <div class="mt-6 flex flex-col-reverse gap-3 sm:flex-row sm:justify-end">
            <button
              id="remove-confirm-cancel"
              type="button"
              class="inline-flex items-center justify-center rounded-full border border-slate-200 bg-white px-4 py-2.5 text-sm font-medium text-slate-600 transition hover:border-slate-300 hover:text-slate-900"
            >
              Cancel
            </button>
            <button
              id="remove-confirm-submit"
              type="button"
              class="inline-flex items-center justify-center rounded-full bg-red-600 px-4 py-2.5 text-sm font-semibold text-white shadow-sm transition hover:bg-red-500 disabled:cursor-not-allowed disabled:bg-red-300"
              disabled
            >
              Delete person
            </button>
          </div>
        </div>
      </div>
    </div>

    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-app.js";
      import {
        getFirestore,
        collection,
        onSnapshot,
        deleteDoc,
        doc,
        updateDoc,
        addDoc,
        serverTimestamp
      } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-firestore.js";
      import { getAnalytics } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-analytics.js";

      const firebaseConfig = {
        apiKey: "AIzaSyBHIWxAFZz9gBEJ12XXF6QK53sY5BEfrVs",
        authDomain: "slink-website.firebaseapp.com",
        projectId: "slink-website",
        storageBucket: "slink-website.firebasestorage.app",
        messagingSenderId: "876458436291",
        appId: "1:876458436291:web:0aff5515ed8b5fdc156476",
        measurementId: "G-KPQSCM484L"
      };

      const app = initializeApp(firebaseConfig);

      if (typeof window !== "undefined" && "location" in window) {
        try {
          getAnalytics(app);
        } catch (error) {
          console.warn("Analytics not initialised", error);
        }
      }

      const db = getFirestore(app);
      const registrationsRef = collection(db, "registrations");
      const submissionsRef = collection(db, "submissions");
      const emailQueueRef = collection(db, "mailQueue");

      const SENDER_EMAIL = "skillbank0@gmail.com";

      const NAV_BASE_CLASSES = [
        "nav-item",
        "flex",
        "w-full",
        "items-center",
        "justify-between",
        "rounded-2xl",
        "border",
        "px-5",
        "py-3.5",
        "text-sm",
        "font-medium",
        "transition",
        "hover:border-slate-200",
        "hover:bg-slate-100",
        "hover:text-slate-900",
        "focus:outline-none"
      ];

      const NAV_ACTIVE_CLASSES = [
        "border-slate-900",
        "bg-slate-900",
        "text-white",
        "shadow-lg",
        "shadow-slate-900/10"
      ];

      const NAV_INACTIVE_CLASSES = [
        "border-transparent",
        "bg-slate-50",
        "text-slate-600"
      ];

      const FILTERS = {
        registered: () => true,
        "new-skill": (person) => person.flags.newSkill,
        "connected-skill": (person) => person.status === "connected",
        "pending-skill": (person) => person.status === "pending",
        "suggested-skill": (person) => person.flags.suggested,
        mailed: (person) => Boolean(person.flags.mailed)
      };

      const SUMMARY_TO_FILTER = {
        registered: "registered",
        newSkill: "new-skill",
        connected: "connected-skill",
        pending: "pending-skill",
        mailed: "mailed"
      };

      const state = {
        people: [],
        activeFilter: "registered",
        searchQuery: "",
        unsubscribe: null,
        unsubscribeSubmissions: null,
        selectedPersonId: null,
        selectedPerson: null,
        selectedTutorId: null,
        selectedTutor: null,
        lastNotifiedTutorId: null,
        submissions: new Map(),
        emailedPersonIds: new Set(),
        mailedPeople: [],
        peopleRetryHandle: null,
        submissionsRetryHandle: null,
        adminUnlocked: true
      };

      const navButtons = document.querySelectorAll(".nav-item");
      const summaryCards = document.querySelectorAll("[data-summary-card]");
      const registrySection = document.getElementById("registry-section");
      const tableBody = document.getElementById("table-body");
      const searchInput = document.getElementById("search-input");
      const resetButton = document.getElementById("reset-filters");
      const notificationRoot = document.getElementById("notification-root");
      const removeConfirmRoot = document.getElementById("remove-confirm");
      const removeConfirmOverlay = document.getElementById("remove-confirm-overlay");
      const removeConfirmDialog = document.getElementById("remove-confirm-dialog");
      const removeConfirmLabel = document.getElementById("remove-confirm-label");
      const removeConfirmName = document.getElementById("remove-confirm-name");
      const removeConfirmInput = document.getElementById("remove-confirm-input");
      const removeConfirmCancel = document.getElementById("remove-confirm-cancel");
      const removeConfirmSubmit = document.getElementById("remove-confirm-submit");
      const removeConfirmDefaultLabel = removeConfirmSubmit
        ? removeConfirmSubmit.textContent.trim() || "Delete person"
        : "Delete person";

      const mailedSection = document.getElementById("mailed-section");
      const mailedList = document.getElementById("mailed-list");
      const mailedEmpty = document.getElementById("mailed-empty");

      function isAdminUnlocked() {
        return true;
      }

      function unlockAdminControls() {
        state.adminUnlocked = true;
        document.querySelectorAll('[data-admin-lockable="true"]').forEach((element) => {
          element.removeAttribute("disabled");
          element.classList.remove("opacity-50", "cursor-not-allowed");
        });
      }

      function syncAdminControls() {
        unlockAdminControls();
      }

      function renderMailedList() {
        if (!mailedSection || !mailedList || !mailedEmpty) return;

        const mailed = state.mailedPeople;
        const isMailedFilter = state.activeFilter === "mailed";

        mailedSection.classList.toggle("hidden", !isMailedFilter);

        if (!isMailedFilter) {
          return;
        }

        if (!mailed.length) {
          mailedList.innerHTML = "";
          mailedEmpty.classList.remove("hidden");
          return;
        }

        mailedEmpty.classList.add("hidden");
        mailedList.innerHTML = mailed
          .map((person) => {
            const scoreValue = Number.isFinite(person.skillTest?.score)
              ? formatSkillTestScore(person.skillTest.score)
              : Number.isFinite(person.skillTest?.rating)
              ? formatSkillTestScore(person.skillTest.rating)
              : null;
            const scoreMarkup = scoreValue
              ? `<span class="text-xs font-semibold text-emerald-600">Score ${scoreValue}</span>`
              : '<span class="text-xs text-slate-400">No score recorded yet</span>';
            const mailedOn = person.mailedAtLabel
              ? `<span class="text-xs text-slate-400">Mailed ${person.mailedAtLabel}</span>`
              : "";

            return `
              <div class="flex items-center justify-between gap-4 px-6 py-4">
                <div>
                  <p class="text-sm font-semibold text-slate-900">${person.name || "Unnamed candidate"}</p>
                  <p class="text-xs text-slate-500">${person.email || "No email"}</p>
                </div>
                <div class="flex flex-col items-end gap-1 text-right">
                  ${scoreMarkup}
                  ${mailedOn}
                </div>
              </div>
            `;
          })
          .join("");
      }

      async function updateMailedStatus(personId, mailed) {
        const checkbox = document.querySelector(`input[data-email-checkbox="${personId}"]`);
        const previousState = state.emailedPersonIds.has(personId);

        if (mailed) {
          state.emailedPersonIds.add(personId);
        } else {
          state.emailedPersonIds.delete(personId);
        }

        try {
          await updateDoc(doc(registrationsRef, personId), {
            mailed,
            mailedAt: mailed ? serverTimestamp() : null
          });
        } catch (error) {
          console.error("Failed to update mailed status", error);
          if (mailed) {
            state.emailedPersonIds.delete(personId);
          } else if (previousState) {
            state.emailedPersonIds.add(personId);
          }
          if (checkbox) {
            checkbox.checked = previousState;
          }
          showToast("Failed to update mailed status. Try again.", { tone: "error" });
        }
      }

      const sidebar = document.getElementById("sidebar");
      const sidebarOverlay = document.getElementById("sidebar-overlay");
      const mobileNavOpen = document.getElementById("mobile-nav-open");
      const mobileNavClose = document.getElementById("mobile-nav-close");

      const detailRoot = document.getElementById("person-detail");
      const detailOverlay = document.getElementById("detail-overlay");
      const detailPanel = document.getElementById("detail-panel");
      const detailStatus = document.getElementById("detail-status");
      const detailName = document.getElementById("detail-name");
      const detailEmail = document.getElementById("detail-email");
      const detailPhone = document.getElementById("detail-phone");
      const detailResumeChip = document.getElementById("detail-resume-chip");
      const detailRegistrationId = document.getElementById("detail-registration-id");
      const detailLocation = document.getElementById("detail-location");
      const detailConnected = document.getElementById("detail-connected");
      const detailCreated = document.getElementById("detail-created");
      const detailEmailValue = document.getElementById("detail-email-value");
      const detailPhoneValue = document.getElementById("detail-phone-value");
      const detailResumeValue = document.getElementById("detail-resume");
      const detailReadyValue = document.getElementById("detail-ready");
      const detailSkillTestValue = document.getElementById("detail-skill-test");
      const detailProfessionalValue = document.getElementById("detail-professional");
      const detailLocationValue = document.getElementById("detail-location-value");
      const detailSource = document.getElementById("detail-source");
      const detailConsent = document.getElementById("detail-consent");
      const detailLearn = document.getElementById("detail-learn-skill");
      const detailTeach = document.getElementById("detail-teach-skills");
      const detailTutorSuggestions = document.getElementById("detail-tutor-suggestions");
      const detailMatchCount = document.getElementById("detail-match-count");
      const detailSelectedTutorSection = document.getElementById("detail-selected-tutor");
      const detailSelectedTutorName = document.getElementById("detail-selected-tutor-name");
      const detailSelectedTutorEmail = document.getElementById("detail-selected-tutor-email");
      const detailSelectedTutorLocation = document.getElementById("detail-selected-tutor-location");
      const detailSelectedTutorPhone = document.getElementById("detail-selected-tutor-phone");
      const detailSelectedTutorHint = document.getElementById("detail-selected-tutor-hint");
      const connectButton = document.getElementById("detail-connect");
      const declineButton = document.getElementById("detail-decline");
      const declineLabel = document.getElementById("detail-decline-label");

      let detailCloseButtons = [];
      let removeConfirmState = {
        personId: null,
        personName: ""
      };

      const body = document.body;

      function openSidebar() {
        if (!sidebar) return;
        
        sidebar.classList.remove("-translate-x-full");
        if (sidebarOverlay) {
          sidebarOverlay.classList.remove("hidden");
          sidebarOverlay.classList.add("opacity-100");
        }
        body.style.overflow = "hidden";
      }

      function closeSidebar({ immediate = false } = {}) {
        if (!sidebar) return;

        sidebar.classList.add("-translate-x-full");
        if (sidebarOverlay) {
          sidebarOverlay.classList.remove("opacity-100");
          if (immediate) {
            sidebarOverlay.classList.add("hidden");
          } else {
            setTimeout(() => {
              if (sidebar.classList.contains("-translate-x-full")) {
                sidebarOverlay.classList.add("hidden");
              }
            }, 300);
          }
        }
        body.style.overflow = "";
      }

      function syncSidebarToViewport() {
        if (!sidebar) return;

        if (window.innerWidth >= 1024) {
          sidebar.classList.remove("-translate-x-full");
          sidebar.classList.remove("hidden");
          if (sidebarOverlay) {
            sidebarOverlay.classList.add("hidden");
            sidebarOverlay.classList.remove("opacity-100");
          }
          body.style.overflow = "";
        } else {
          sidebar.classList.add("-translate-x-full");
          if (sidebarOverlay) {
            sidebarOverlay.classList.add("hidden");
            sidebarOverlay.classList.remove("opacity-100");
          }
        }
      }

      function parseCreatedAt(value) {
        if (!value) return "";

        if (typeof value === "string") {
          const timestamp = Date.parse(value);
          if (!Number.isNaN(timestamp)) {
            return new Intl.DateTimeFormat("en-GB", {
              day: "numeric",
              month: "long",
              year: "numeric"
            }).format(new Date(timestamp));
          }
          return value;
        }

        const date = typeof value.toDate === "function" ? value.toDate() : new Date(value);
        if (Number.isNaN(date.getTime())) return "";

        return new Intl.DateTimeFormat("en-GB", {
          day: "numeric",
          month: "long",
          year: "numeric"
        }).format(date);
      }

      function formatInteger(value) {
        return new Intl.NumberFormat("en-US", { maximumFractionDigits: 0 }).format(
          typeof value === "number" && Number.isFinite(value) ? value : 0
        );
      }

      function formatSkillTestScore(value) {
        const numeric =
          typeof value === "number"
            ? value
            : value != null && value !== ""
            ? Number.parseFloat(value)
            : Number.NaN;
        if (!Number.isFinite(numeric)) return "";
        return Number.isInteger(numeric) ? String(numeric) : numeric.toFixed(1);
      }

      function parseNumericValue(value) {
        if (typeof value === "number") {
          return Number.isFinite(value) ? value : Number.NaN;
        }
        if (typeof value === "string") {
          const cleaned = value.trim();
          if (!cleaned) return Number.NaN;
          const normalised = cleaned.replace(/[^0-9.+-]/g, "");
          if (!normalised) return Number.NaN;
          const parsed = Number.parseFloat(normalised);
          return Number.isFinite(parsed) ? parsed : Number.NaN;
        }
        return Number.NaN;
      }

      function hydrateSubmission(docSnap) {
        const data = docSnap.data() ?? {};

        const scoreCandidates = [
          data.correctCount,
          data.correct_count,
          data.readinessScore,
          data.score,
          data.totalScore,
          data.resultScore,
          data.overallScore,
          data.rating
        ];
        let score = Number.NaN;
        for (const candidate of scoreCandidates) {
          const parsed = parseNumericValue(candidate);
          if (Number.isFinite(parsed)) {
            score = parsed;
            break;
          }
        }

        const ratingCandidates = [data.rating, data.average, data.meanScore];
        let rating = Number.NaN;
        for (const candidate of ratingCandidates) {
          const parsed = parseNumericValue(candidate);
          if (Number.isFinite(parsed)) {
            rating = parsed;
            break;
          }
        }

        const passingCandidates = [
          data.passingScore,
          data.threshold,
          data.minimumScore,
          data.passMark,
          data.passing
        ];
        let passingScore = Number.NaN;
        for (const candidate of passingCandidates) {
          const parsed = parseNumericValue(candidate);
          if (Number.isFinite(parsed)) {
            passingScore = parsed;
            break;
          }
        }

        const boolFrom = (value) =>
          typeof value === "boolean" ? value : null;

        const takenFlag =
          boolFrom(data.taken) ??
          boolFrom(data.completed) ??
          boolFrom(data.submitted) ??
          boolFrom(data.isComplete) ??
          (Number.isFinite(score) ? true : null);

        const readyFlag =
          boolFrom(data.ready) ??
          boolFrom(data.isReady) ??
          boolFrom(data.readyToTeach) ??
          boolFrom(data.passed) ??
          boolFrom(data.isQualified) ??
          null;

        const statusRaw = typeof data.status === "string" ? data.status.toLowerCase() : "";

        const linkKeyCandidates = [
          docSnap.id,
          data.code,
          data.registrationId,
          data.registrantId,
          data.personId,
          data.personID,
          data.profileId,
          data.profileID,
          data.userId,
          data.userID,
          data.uid,
          data.tutorId,
          data.tutorID
        ];
        const linkKeys = new Set(
          linkKeyCandidates
            .map((value) => (typeof value === "string" || typeof value === "number" ? String(value).trim().toLowerCase() : ""))
            .filter(Boolean)
        );

        const emailCandidates = [
          data.email,
          data.userEmail,
          data.contactEmail,
          data.loginEmail,
          ...(Array.isArray(data.emails) ? data.emails : []),
          ...(Array.isArray(data.contactEmails) ? data.contactEmails : [])
        ];
        const emails = new Set(
          emailCandidates
            .map((value) => (typeof value === "string" ? value.trim().toLowerCase() : ""))
            .filter(Boolean)
        );

        const scoreValue = Number.isFinite(score) ? score : null;
        const ratingValue = Number.isFinite(rating) ? rating : null;
        const passingValue = Number.isFinite(passingScore) ? passingScore : null;

        let ready = readyFlag;
        if (ready == null && Number.isFinite(score) && Number.isFinite(passingScore)) {
          ready = score >= passingScore;
        }
        if (ready == null && takenFlag === true && (Number.isFinite(score) || Number.isFinite(rating))) {
          ready = true;
        }

        const status = statusRaw || (ready ? "ready" : takenFlag ? "completed" : "pending");

        return {
          id: docSnap.id,
          score: scoreValue,
          rating: ratingValue,
          passingScore: passingValue,
          taken: takenFlag ?? Boolean(scoreValue ?? ratingValue),
          ready: ready ?? false,
          status,
          linkKeys,
          emails
        };
      }

      function getSkillTestBadge(skillTest = {}, { variant = "chip" } = {}) {
        const hasTaken = Boolean(skillTest?.taken);
        const scoreSource = Number.isFinite(skillTest?.score)
          ? skillTest.score
          : Number.isFinite(skillTest?.rating)
          ? skillTest.rating
          : null;
        const scoreValue = formatSkillTestScore(scoreSource);
        const starClass =
          variant === "detail"
            ? "h-4 w-4"
            : variant === "meta" || variant === "mobile"
            ? "h-3 w-3"
            : "h-3.5 w-3.5";
        const starSvg = `<svg xmlns="http://www.w3.org/2000/svg" class="${starClass} text-amber-500" viewBox="0 0 24 24" fill="currentColor"><path d="M11.48 3.499a.562.562 0 011.04 0l2.125 5.111 5.518.4a.562.562 0 01.314.98l-4.204 3.6 1.285 5.385a.562.562 0 01-.84.61L12 16.347l-4.719 3.238a.562.562 0 01-.84-.61l1.285-5.386-4.204-3.6a.562.562 0 01.314-.98l5.518-.4L11.48 3.5z"/></svg>`;
        const starsMarkup = hasTaken ? Array.from({ length: 4 }, () => starSvg).join("") : "";
        const notTakenIconClass =
          variant === "detail"
            ? "h-4 w-4"
            : variant === "meta" || variant === "mobile"
            ? "h-3 w-3"
            : "h-3.5 w-3.5";
        const notTakenIcon = `<svg xmlns="http://www.w3.org/2000/svg" class="${notTakenIconClass} text-slate-400" viewBox="0 0 24 24" fill="none" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M12 9v3.75m0 3.75h.007v.007H12v-.007zM21 12A9 9 0 113 12a9 9 0 0118 0z"/></svg>`;
        const readyLabel = "Ready to teach";

        if (!hasTaken) {
          if (variant === "detail") {
            return `<span class="inline-flex items-center gap-2 text-slate-500">${notTakenIcon}<span>Test not taken</span></span>`;
          }
          if (variant === "meta") {
            return `<span class="flex items-center gap-1 text-xs font-semibold text-slate-400">${notTakenIcon}<span>Test not taken</span></span>`;
          }
          if (variant === "mobile") {
            return `<span class="slink-table-chip bg-slate-200/70 text-slate-600"><svg xmlns=\"http://www.w3.org/2000/svg\" class=\"h-3 w-3 text-slate-500\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\"><path stroke-linecap=\"round\" stroke-linejoin=\"round\" stroke-width=\"1.5\" d=\"M12 9v3.75m0 3.75h.007v.007H12v-.007zM21 12A9 9 0 113 12a9 9 0 0118 0z\"/></svg>Test not taken</span>`;
          }
          return `<span class="inline-flex items-center gap-1 rounded-full bg-slate-100 px-2.5 py-1 text-xs font-semibold text-slate-500">${notTakenIcon}<span>Test not taken</span></span>`;
        }

        if (variant === "detail") {
          const detailScore = scoreValue
            ? `<span class="text-xs font-medium text-slate-500">Score: ${scoreValue}</span>`
            : "";
          return `<span class="inline-flex flex-wrap items-center gap-2 text-amber-600"><span class="flex items-center gap-1">${starsMarkup}</span><span class="text-sm font-semibold text-slate-700">${readyLabel}</span>${detailScore}</span>`;
        }

        if (variant === "meta") {
          const metaScore = scoreValue
            ? `<span class="text-[10px] font-medium text-slate-400">(Score ${scoreValue})</span>`
            : "";
          return `<span class="flex items-center gap-1 text-xs font-semibold text-amber-600"><span class="flex items-center gap-0.5">${starsMarkup}</span><span>${readyLabel}</span>${metaScore}</span>`;
        }

        if (variant === "mobile") {
          const mobileScore = scoreValue
            ? `<span class="text-[10px] font-semibold text-amber-700/80">Score: ${scoreValue}</span>`
            : "";
          return `<span class="slink-table-chip bg-amber-100 text-amber-700"><span class="flex items-center gap-0.5">${starsMarkup}</span><span>${readyLabel}</span>${mobileScore}</span>`;
        }

        const chipScore = scoreValue
          ? `<span class="text-[10px] font-semibold text-amber-600/80">Score: ${scoreValue}</span>`
          : "";
        return `<span class="inline-flex items-center gap-2 rounded-full bg-amber-50 px-2.5 py-1 text-xs font-semibold text-amber-600"><span class="flex items-center gap-0.5">${starsMarkup}</span><span>${readyLabel}</span>${chipScore}</span>`;
      }

      function showToast(message, { tone = "success", timeout = 4000 } = {}) {
        if (!notificationRoot) return;

        const toneClasses =
          tone === "error"
            ? "bg-red-600 text-white"
            : tone === "warning"
            ? "bg-amber-500 text-slate-900"
            : "bg-emerald-600 text-white";

        const toast = document.createElement("div");
        toast.className = `pointer-events-auto inline-flex items-center gap-3 rounded-full px-5 py-3 text-sm font-medium shadow-lg shadow-slate-900/20 transition-opacity duration-300 ease-out ${toneClasses}`;
        toast.innerHTML = `
          <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M12 9v3.75m0 3.75h.007v.007H12v-.007zM21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
          </svg>
          <span>${message}</span>
        `;

        notificationRoot.appendChild(toast);

        requestAnimationFrame(() => {
          toast.classList.remove("opacity-0");
        });

        setTimeout(() => {
          toast.classList.add("opacity-0");
          setTimeout(() => toast.remove(), 300);
        }, timeout);
      }

      function escapeCsv(value) {
        if (value == null) return "";
        const text = String(value).replace(/"/g, '""');
        return /[",\n]/.test(text) ? `"${text}"` : text;
      }

      function buildPeopleCsv(people) {
        const header = [
          "Name",
          "Email",
          "Phone",
          "Location",
          "Status",
          "Registered",
          "Teach Skills",
          "Learn Skills",
          "Source",
          "Skill Test Score",
          "Skill Test Status"
        ];

        const rows = people.map((person) =>
          [
            person.name,
            person.email,
            person.phone,
            person.location,
            person.status,
            person.createdAtLabel,
            person.teachSkills.join("; "),
            person.learnSkills.join("; "),
            person.source,
            Number.isFinite(person.skillTest?.score)
              ? person.skillTest.score
              : Number.isFinite(person.skillTest?.rating)
              ? person.skillTest.rating
              : "",
            person.skillTest?.taken ? "Completed" : "Not taken"
          ].map(escapeCsv).join(",")
        );

        return [header.join(","), ...rows].join("\r\n");
      }

      function hydratePerson(docSnap) {
        const data = docSnap.data() ?? {};
        const rawStatus = String(data.status ?? "").toLowerCase();
        const normalizedStatus = ["connected", "verified"].includes(rawStatus)
          ? "connected"
          : "pending";

        const teachSkills = Array.isArray(data.teachSkills)
          ? data.teachSkills.filter(Boolean)
          : [];
        const learnSkills = data.selectedSkill ? [data.selectedSkill] : [];

        const skills = [...new Set([...teachSkills, ...learnSkills])];

        const resumeUrl =
          data.resumeUrl ??
          data.resumeLink ??
          data.resume ??
          data.cvUrl ??
          data.cv ??
          data.portfolioResume ??
          "";
        const resumeStatus =
          data.resumeStatus ?? data.resume_state ?? data.resumeApprovalStatus ?? data.resumeState ?? "";
        const resumeReady = Boolean(
          data.readyForLinking ??
            data.resumeApproved ??
            data.resumeReady ??
            data.professionalReady ??
            data.isProfessional ??
            data.professional ??
            data.mentorReady ??
            false
        );
        const resumeSubmitted = Boolean(resumeUrl);
        const resumeUpdatedLabel = resumeSubmitted
          ? parseCreatedAt(data.resumeUpdatedAt ?? data.resumeReviewedAt ?? data.resumeUpdated ?? null)
          : "";
        const isProfessional = Boolean(
          data.isProfessional ?? data.professional ?? data.isMentor ?? data.profileType === "professional"
        );

        const linkKeyCandidates = [
          docSnap.id,
          data.code,
          data.registrationId,
          data.registrantId,
          data.personId,
          data.personID,
          data.profileId,
          data.profileID,
          data.userId,
          data.userID,
          data.uid,
          data.tutorId,
          data.tutorID
        ];
        const linkKeys = new Set(
          linkKeyCandidates
            .map((value) =>
              typeof value === "string" || typeof value === "number"
                ? String(value).trim().toLowerCase()
                : ""
            )
            .filter(Boolean)
        );

        const emailCandidates = [
          data.email,
          data.userEmail,
          data.contactEmail,
          data.loginEmail,
          ...(Array.isArray(data.emails) ? data.emails : []),
          ...(Array.isArray(data.contactEmails) ? data.contactEmails : [])
        ];
        const emails = new Set(
          emailCandidates
            .map((value) => (typeof value === "string" ? value.trim().toLowerCase() : ""))
            .filter(Boolean)
        );

        const rawSkillTestScore =
          typeof data.skillTestScore !== "undefined"
            ? data.skillTestScore
            : typeof data.skillTestRating !== "undefined"
            ? data.skillTestRating
            : typeof data.skillTestResult !== "undefined"
            ? data.skillTestResult
            : typeof data.skillAssessmentScore !== "undefined"
            ? data.skillAssessmentScore
            : typeof data.assessmentScore !== "undefined"
            ? data.assessmentScore
            : null;
        const parsedSkillTestScore =
          typeof rawSkillTestScore === "number"
            ? rawSkillTestScore
            : rawSkillTestScore != null && rawSkillTestScore !== ""
            ? Number.parseFloat(rawSkillTestScore)
            : Number.NaN;
        const hasSkillTestScore = Number.isFinite(parsedSkillTestScore);
        const normalizedSkillTestStatus =
          typeof data.skillTestStatus === "string" ? data.skillTestStatus.toLowerCase() : "";
        const skillTestTaken =
          Boolean(
            data.skillTestTaken ??
              data.skillTestCompleted ??
              data.skillTestPassed ??
              data.hasTakenSkillTest ??
              data.readyToTeach ??
              data.readyForTeaching
          ) ||
          ["completed", "passed", "ready", "finished"].includes(normalizedSkillTestStatus) ||
          hasSkillTestScore;
        const skillTestPassingScore =
          typeof data.skillTestPassingScore === "number"
            ? data.skillTestPassingScore
            : typeof data.skillTestPassingScore === "string"
            ? Number.parseFloat(data.skillTestPassingScore)
            : null;
        const readyToTeach =
          Boolean(
            data.readyToTeach ??
              data.skillTestPassed ??
              data.skillTestReady ??
              (skillTestTaken &&
                (!Number.isFinite(skillTestPassingScore) ||
                  (hasSkillTestScore && parsedSkillTestScore >= skillTestPassingScore)))
          );
        const skillTestStatus =
          normalizedSkillTestStatus || (skillTestTaken ? "completed" : "pending");
        const skillTestRatingValue =
          typeof data.skillTestRating === "number"
            ? data.skillTestRating
            : typeof data.rating === "number"
            ? data.rating
            : null;
        const normalizedSkillTestRating = Number.isFinite(skillTestRatingValue)
          ? skillTestRatingValue
          : hasSkillTestScore
          ? parsedSkillTestScore
          : null;

        const baseSkillTest = {
          taken: skillTestTaken,
          status: skillTestStatus,
          score: hasSkillTestScore ? parsedSkillTestScore : null,
          rating: Number.isFinite(normalizedSkillTestRating) ? normalizedSkillTestRating : null,
          ready: readyToTeach
        };

        return {
          id: docSnap.id,
          name: data.fullName ?? "Unknown registrant",
          email: data.email ?? "",
          phone: data.phone ?? data.phoneNumber ?? data.contactNumber ?? "",
          location: data.location ?? "",
          createdAtLabel: parseCreatedAt(data.createdAt),
          createdAtValue: (() => {
            if (!data.createdAt) return 0;
            if (typeof data.createdAt === "string") {
              const timestamp = Date.parse(data.createdAt);
              return Number.isNaN(timestamp) ? 0 : timestamp;
            }
            const date = typeof data.createdAt.toDate === "function"
              ? data.createdAt.toDate()
              : new Date(data.createdAt);
            return Number.isNaN(date.getTime()) ? 0 : date.getTime();
          })(),
          status: normalizedStatus,
          skills,
          teachSkills,
          learnSkills,
          resume: {
            url: resumeUrl || "",
            status: resumeStatus || "",
            submitted: resumeSubmitted,
            ready: resumeReady,
            updatedAtLabel: resumeUpdatedLabel
          },
          readyForLinking: resumeReady,
          readyToTeach,
          skillTest: { ...baseSkillTest },
          _skillTestBase: baseSkillTest,
          linkKeys,
          emails,
          isProfessional,
          flags: {
            newSkill: data.source === "client-submission",
            suggested: data.source === "ai-suggestion",
            mailed: Boolean(data.mailed)
          },
          mailedAtLabel: parseCreatedAt(data.mailedAt),
          connectedTutorId: data.connectedTutorId ?? "",
          connectedTutorName: data.connectedTutorName ?? "",
          connectedTutorLocation: data.connectedTutorLocation ?? "",
          connectedTutorEmail: data.connectedTutorEmail ?? "",
          connectedTutorPhone: data.connectedTutorPhone ?? "",
          connectedAtLabel: parseCreatedAt(data.connectedAt),
          connectedAtValue: (() => {
            if (!data.connectedAt) return 0;
            if (typeof data.connectedAt === "string") {
              const timestamp = Date.parse(data.connectedAt);
              return Number.isNaN(timestamp) ? 0 : timestamp;
            }
            const date =
              typeof data.connectedAt?.toDate === "function"
                ? data.connectedAt.toDate()
                : new Date(data.connectedAt);
            return Number.isNaN(date.getTime()) ? 0 : date.getTime();
          })(),
          consent: typeof data.consent === "boolean" ? data.consent : null,
          source: data.source ?? ""
        };
      }

      function setsIntersect(a, b) {
        if (!a || !b || !(a instanceof Set) || !(b instanceof Set)) return false;
        if (a.size === 0 || b.size === 0) return false;
        for (const value of a) {
          if (b.has(value)) return true;
        }
        return false;
      }

      function pickBestSubmission(person) {
        if (!state.submissions?.size) return null;
        const personKeys = person.linkKeys instanceof Set ? person.linkKeys : new Set();
        const personEmails = person.emails instanceof Set ? person.emails : new Set();

        let bestSubmission = null;
        let bestScore = Number.NEGATIVE_INFINITY;

        state.submissions.forEach((submission) => {
          const matchesId = setsIntersect(personKeys, submission.linkKeys);
          const matchesEmail = setsIntersect(personEmails, submission.emails);
          if (!matchesId && !matchesEmail) return;

          let priorityScore = Number.NEGATIVE_INFINITY;
          if (Number.isFinite(submission.score)) {
            priorityScore = submission.score;
          } else if (Number.isFinite(submission.rating)) {
            priorityScore = submission.rating;
          } else if (submission.ready) {
            priorityScore = Number.POSITIVE_INFINITY;
          }

          if (priorityScore > bestScore) {
            bestScore = priorityScore;
            bestSubmission = submission;
          }
        });

        return bestSubmission;
      }

      function applySubmissionsToPeople() {
        if (!Array.isArray(state.people) || !state.people.length) return;

        state.people.forEach((person) => {
          const base = person._skillTestBase ?? person.skillTest ?? {};
          const merged = {
            taken: base.taken ?? false,
            status: base.status ?? "",
            score: Number.isFinite(base.score) ? base.score : null,
            rating: Number.isFinite(base.rating) ? base.rating : null,
            ready: base.ready ?? false
          };

          const submission = pickBestSubmission(person);

          if (submission) {
            if (Number.isFinite(submission.score)) {
              merged.score = submission.score;
            }
            if (Number.isFinite(submission.rating)) {
              merged.rating = submission.rating;
            }
            if (typeof submission.ready === "boolean") {
              merged.ready = submission.ready;
            }
            if (typeof submission.taken === "boolean") {
              merged.taken = submission.taken;
            }
            merged.status = submission.status || (merged.ready ? "ready" : merged.taken ? "completed" : "pending");
            person.skillTestSubmissionId = submission.id;
          } else {
            merged.status = merged.status || (merged.ready ? "ready" : merged.taken ? "completed" : "pending");
            person.skillTestSubmissionId = null;
          }

          person.skillTest = merged;
          person.readyToTeach = Boolean(merged.ready);
        });

        if (state.selectedPersonId) {
          const active = state.people.find((candidate) => candidate.id === state.selectedPersonId);
          if (active) {
            state.selectedPerson = active;
          }
        }
      }

      function applyFilter(data) {
        const filterFn = FILTERS[state.activeFilter];
        return data.filter(filterFn);
      }

      function applySearch(data) {
        const query = state.searchQuery.trim().toLowerCase();
        if (!query) return data;

        return data.filter((person) => {
          const matchesName = person.name.toLowerCase().includes(query);
          const matchesSkill = person.skills.some((skill) =>
            skill.toLowerCase().includes(query)
          );
          const matchesEmail = person.email.toLowerCase().includes(query);
          const matchesLocation = person.location.toLowerCase().includes(query);
          return matchesName || matchesSkill || matchesEmail || matchesLocation;
        });
      }

      function getStatusPillClasses(status) {
        return status === "connected"
          ? "inline-flex items-center gap-2 rounded-full bg-emerald-50 px-3 py-1 text-xs font-medium text-emerald-700"
          : "inline-flex items-center gap-2 rounded-full bg-amber-50 px-3 py-1 text-xs font-medium text-amber-700";
      }

      function renderTable() {
        const filtered = applySearch(applyFilter(state.people));
        const showRowDetails = state.activeFilter !== "registered";

        if (!filtered.length) {
          tableBody.innerHTML = `
            <tr>
              <td colspan="6" class="px-6 py-16 text-center text-sm text-slate-400">
                No records match the current filters. Adjust the criteria to continue monitoring skills.
              </td>
            </tr>
          `;
          return;
        }

        tableBody.innerHTML = filtered
          .map((person) => {
            const connectedTutor =
              person.status === "connected" && person.connectedTutorId
                ? state.people.find((candidate) => candidate.id === person.connectedTutorId) || null
                : null;
            const connectedTutorName = connectedTutor?.name || person.connectedTutorName || "";

            const statusClass = person.status === "connected" ? "status-completed" : "status-pending";
            
            const resume = person.resume ?? { submitted: false, ready: false };
            const readinessBadge = resume.ready
              ? `<span class="athena-status-pill status-completed">Ready</span>`
              : resume.submitted
              ? `<span class="athena-status-pill status-pending">Review</span>`
              : `<span class="athena-status-pill bg-slate-100 text-slate-500">None</span>`;

            const isEmailSent = Boolean(person.flags.mailed);
            const scoreValue = Number.isFinite(person.skillTest?.score)
                ? formatSkillTestScore(person.skillTest.score)
                : Number.isFinite(person.skillTest?.rating)
                ? formatSkillTestScore(person.skillTest.rating)
                : null;

            const teachSkillsMarkup = person.teachSkills
              .slice(0, 2)
              .map(skill => `<span class="inline-flex items-center px-1.5 py-0.5 rounded text-[10px] font-medium bg-emerald-50 text-emerald-700 border border-emerald-100">${skill}</span>`)
              .join(" ");

            const learnSkillsMarkup = person.learnSkills
              .slice(0, 2)
              .map(skill => `<span class="inline-flex items-center px-1.5 py-0.5 rounded text-[10px] font-medium bg-blue-50 text-blue-700 border border-blue-100">${skill}</span>`)
              .join(" ");

            const moreTeach = person.teachSkills.length > 2 ? `<span class="text-[10px] text-slate-400">+${person.teachSkills.length - 2}</span>` : "";
            const moreLearn = person.learnSkills.length > 2 ? `<span class="text-[10px] text-slate-400">+${person.learnSkills.length - 2}</span>` : "";

            return `
              <tr class="hover:bg-slate-50 transition-colors cursor-pointer group" data-person-id="${person.id}">
                <td class="athena-table td"><input type="checkbox" class="rounded text-indigo-600" /></td>
                <td class="athena-table td" data-label="Registrant">
                  <div class="flex items-center gap-3">
                    <div class="w-8 h-8 rounded-full bg-slate-100 flex items-center justify-center text-xs font-bold text-slate-500">
                      ${person.name.charAt(0)}
                    </div>
                    <div>
                      <div class="text-sm font-semibold text-slate-900">${person.name}</div>
                      <div class="text-xs text-slate-500">${person.email || "No email"}</div>
                    </div>
                  </div>
                </td>
                <td class="athena-table td" data-label="Skills">
                  <div class="flex flex-col gap-2">
                    <div class="flex flex-col gap-1">
                      <span class="text-[10px] font-bold text-slate-400 uppercase tracking-tighter">Teach</span>
                      <div class="flex flex-wrap gap-1 items-center">
                        ${teachSkillsMarkup || '<span class="text-[10px] text-slate-300">None</span>'}${moreTeach}
                      </div>
                    </div>
                    <div class="flex flex-col gap-1">
                      <span class="text-[10px] font-bold text-slate-400 uppercase tracking-tighter">Learn</span>
                      <div class="flex flex-wrap gap-1 items-center">
                        ${learnSkillsMarkup || '<span class="text-[10px] text-slate-300">None</span>'}${moreLearn}
                      </div>
                    </div>
                  </div>
                </td>
                <td class="athena-table td" data-label="Status">
                  <div class="flex items-center gap-2">
                    <input type="checkbox" class="status-toggle-checkbox h-4 w-4 rounded text-emerald-600 focus:ring-emerald-500" 
                      data-status-checkbox="${person.id}" ${person.status === "connected" ? "checked" : ""} />
                    <span class="athena-status-pill ${statusClass} capitalize">${person.status}</span>
                  </div>
                </td>
                <td class="athena-table td" data-label="Readiness">
                  <div class="flex flex-col gap-1">
                    ${readinessBadge}
                    ${scoreValue ? `<span class="text-[10px] font-bold text-slate-400 uppercase">Score: ${scoreValue}</span>` : ""}
                  </div>
                </td>
                <td class="athena-table td text-right" data-label="Actions">
                  <div class="flex items-center justify-end gap-3">
                    <label class="flex items-center gap-1 cursor-pointer">
                      <input type="checkbox" class="email-sent-checkbox h-4 w-4 rounded text-indigo-600" 
                        data-email-checkbox="${person.id}" ${isEmailSent ? "checked" : ""} />
                      <span class="text-xs text-slate-500">Mail</span>
                    </label>
                    <button class="p-1 text-slate-400 hover:text-red-600 transition" data-action="remove" data-id="${person.id}">
                      <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/></svg>
                    </button>
                  </div>
                </td>
              </tr>
            `;
          })
          .join("");
      }

      function renderSelectedTutor(tutor) {
        if (!detailSelectedTutorSection) return;

        if (!tutor) {
          detailSelectedTutorSection.classList.add("hidden");
          detailSelectedTutorName.textContent = "";
          detailSelectedTutorEmail.innerHTML = "";
          detailSelectedTutorLocation.innerHTML = "";
          detailSelectedTutorPhone.innerHTML = "";
          detailSelectedTutorHint.textContent = "";
          return;
        }

        detailSelectedTutorSection.classList.remove("hidden");
        detailSelectedTutorName.textContent = tutor.name || "Tutor";
        detailSelectedTutorEmail.innerHTML = tutor.email
          ? `<a class="text-slate-600 underline decoration-dotted underline-offset-2" href="mailto:${tutor.email}">${tutor.email}</a>`
          : '<span class="text-slate-400">No email on file</span>';
        detailSelectedTutorLocation.innerHTML = tutor.location
          ? `<span class="text-slate-600">${tutor.location}</span>`
          : '<span class="text-slate-400">No location on file</span>';
        detailSelectedTutorPhone.innerHTML = tutor.phone
          ? `<a class="text-slate-600 underline decoration-dotted underline-offset-2" href="tel:${tutor.phone}">${tutor.phone}</a>`
          : '<span class="text-slate-400">No phone on file</span>';

        const activePerson = state.selectedPerson;
        const isCurrentConnection =
          activePerson?.status === "connected" &&
          activePerson?.connectedTutorId &&
          tutor.id === activePerson.connectedTutorId;

        if (isCurrentConnection) {
          const connectedOn = activePerson.connectedAtLabel
            ? `Connected on ${activePerson.connectedAtLabel}.`
            : "This learner is currently connected to this tutor.";
          detailSelectedTutorHint.textContent = connectedOn;
          return;
        }

        const emailHint = tutor.email
          ? `We will notify ${tutor.email} with the learner details.`
          : "Add an email to automatically notify this tutor.";
        const phoneHint = tutor.phone
          ? `Share ${tutor.phone} with the learner for direct scheduling.`
          : "Collect a phone number to enable quick follow-ups.";
        const notificationHint =
          state.lastNotifiedTutorId && tutor.id && state.lastNotifiedTutorId === tutor.id
            ? " Notification emails have been queued for both tutor and learner."
            : "";

        detailSelectedTutorHint.textContent = `${emailHint} ${phoneHint}${notificationHint}`.trim();
      }

      function setActiveFilter(filter) {
        state.activeFilter = filter;
        document.querySelectorAll(".athena-nav-item").forEach((button) => {
          const isActive = button.dataset.filter === filter;
          button.classList.toggle("active", isActive);
        });

        summaryCards.forEach((card) => {
          const summaryKey = card.getAttribute("data-summary-card");
          const isActive = SUMMARY_TO_FILTER[summaryKey] === filter;
          card.classList.toggle("summary-card--active", isActive);
          card.setAttribute("aria-pressed", String(isActive));
        });

        renderTable();
        renderMailedList();
      }

      async function removePerson(id) {
        if (!id) return;

        try {
          await deleteDoc(doc(registrationsRef, id));

          if (state.selectedPersonId === id) {
            closeDetail();
          }
        } catch (error) {
          console.error("Failed to remove person", error);
          throw error;
        }
      }

      function resetFilters() {
        state.searchQuery = "";
        if (searchInput) searchInput.value = "";
        setActiveFilter("registered");
        updateCounts();
        renderTable();
      }

      function updateCounts() {
        const counts = state.people.reduce(
          (accumulator, person) => {
            accumulator.registered += 1;
            if (person.flags.newSkill) accumulator.newSkill += 1;
            if (person.status === "connected") accumulator.connected += 1;
            if (person.status === "pending") accumulator.pending += 1;
            if (person.flags.suggested) accumulator.suggested += 1;
            if (person.flags.mailed) accumulator.mailed += 1;
            return accumulator;
          },
          {
            registered: 0,
            newSkill: 0,
            connected: 0,
            pending: 0,
            suggested: 0,
            mailed: 0
          }
        );

        document.querySelectorAll("[data-summary-card]").forEach((card) => {
          const key = card.getAttribute("data-summary-card");
          const valueNode = card.querySelector("[data-summary-value]");
          if (!key || !valueNode) return;

          const metricValue = counts[key] ?? 0;
          valueNode.textContent = formatInteger(metricValue);

          if (key === "registered") {
            const mailedCount = counts.mailed ?? 0;
            const tooltip = mailedCount
              ? `${formatInteger(metricValue)} total, ${formatInteger(mailedCount)} mailed`
              : `${formatInteger(metricValue)} total`;
            card.setAttribute("title", tooltip);
          }
        });

        document.querySelectorAll("[data-badge-count]").forEach((badge) => {
          const key = badge.getAttribute("data-badge-count");
          badge.textContent = formatInteger(counts[key] ?? 0);
        });

        state.mailedPeople = state.people.filter((person) => person.flags.mailed);
        renderMailedList();
      }

      document.querySelectorAll(".athena-nav-item").forEach((button) => {
        button.addEventListener("click", () => {
          const filter = button.dataset.filter;
          if (filter) {
            setActiveFilter(filter);
            if (window.innerWidth < 1024) {
              closeSidebar();
            }
          }
        });
      });

      summaryCards.forEach((card) => {
        const summaryKey = card.getAttribute("data-summary-card");
        const filter = SUMMARY_TO_FILTER[summaryKey];
        if (!filter) return;

        const handleActivate = (event) => {
          if (event.type === "keydown" && !["Enter", " ", "Spacebar"].includes(event.key)) {
            return;
          }
          event.preventDefault();
          setActiveFilter(filter);
          registrySection?.scrollIntoView({ behavior: "smooth", block: "start" });
        };

        card.addEventListener("click", handleActivate);
        card.addEventListener("keydown", handleActivate);
      });

      if (mobileNavOpen) {
        mobileNavOpen.addEventListener("click", (e) => {
          e.stopPropagation();
          openSidebar();
        });
      }

      if (mobileNavClose) {
        mobileNavClose.addEventListener("click", () => closeSidebar());
      }

      if (sidebarOverlay) {
        sidebarOverlay.addEventListener("click", () => closeSidebar());
      }

      window.addEventListener("resize", syncSidebarToViewport);

      window.addEventListener("keydown", (event) => {
        if (event.key === "Escape") {
          closeSidebar();
        }
      });

      if (searchInput) {
        searchInput.addEventListener("input", (event) => {
          state.searchQuery = event.target.value;
          renderTable();
        });
      }

      if (resetButton) {
        resetButton.addEventListener("click", resetFilters);
      }


      tableBody.addEventListener("change", (event) => {
        const statusCheckbox = event.target.closest("input[data-status-checkbox]");
        if (statusCheckbox) {
          const personId = statusCheckbox.dataset.statusCheckbox;
          const isConnected = statusCheckbox.checked;
          const person = state.people.find(p => p.id === personId);
          
          if (isConnected) {
            // If they have a selected tutor in state, use it, otherwise just mark as connected
            const tutor = state.selectedTutor || null;
            connectPerson(person, tutor).catch(err => {
              console.error("Manual connection toggle failed", err);
              statusCheckbox.checked = false;
            });
          } else {
            revertToPending(personId).catch(err => {
              console.error("Manual revert toggle failed", err);
              statusCheckbox.checked = true;
            });
          }
          return;
        }

        const emailCheckbox = event.target.closest("input[data-email-checkbox]");
        if (emailCheckbox) {
          const personId = emailCheckbox.dataset.emailCheckbox;
          updateMailedStatus(personId, emailCheckbox.checked);
          return;
        }
      });

      tableBody.addEventListener("click", (event) => {
        const removeTrigger = event.target.closest("button[data-action=\"remove\"]");
        if (removeTrigger) {
          const { id } = removeTrigger.dataset;
          const person = state.people.find((item) => item.id === id);
          if (person) {
            openRemoveConfirm(person);
          }
          return;
        }

        const checkbox = event.target.closest("input[data-email-checkbox]");
        if (checkbox) {
          return;
        }

        const checkboxLabel = event.target.closest("label");
        if (checkboxLabel && checkboxLabel.querySelector("input[data-email-checkbox]")) {
          return;
        }

        const row = event.target.closest("tr[data-person-id]");
        if (!row) return;

        const person = state.people.find((item) => item.id === row.dataset.personId);
        if (!person) return;

        openDetail(person);
      });

      function subscribeToPeople() {
        if (state.unsubscribe) state.unsubscribe();
        state.unsubscribe = onSnapshot(
          registrationsRef,
          (snapshot) => {
            state.people = snapshot.docs.map(hydratePerson);

            state.people.sort((a, b) => b.createdAtValue - a.createdAtValue);

            applySubmissionsToPeople();
            updateCounts();
            renderTable();

            if (state.selectedPersonId) {
              const active = state.people.find((person) => person.id === state.selectedPersonId);
              if (active) {
                renderDetail(active);
              } else {
                closeDetail();
              }
            }
          },
          (error) => {
            console.error("Realtime registration subscription failed", error);
            showToast("Realtime updates are unavailable. Showing latest snapshot.", { tone: "warning" });
          }
        );
      }

      function subscribeToSubmissions() {
        if (state.unsubscribeSubmissions) state.unsubscribeSubmissions();
        state.unsubscribeSubmissions = onSnapshot(
          submissionsRef,
          (snapshot) => {
            const submissions = new Map();
            snapshot.docs.forEach((docSnap) => {
              const submission = hydrateSubmission(docSnap);
              submissions.set(docSnap.id, submission);
            });
            state.submissions = submissions;

            applySubmissionsToPeople();
            updateCounts();
            renderTable();

            if (state.selectedPersonId) {
              const active = state.people.find((person) => person.id === state.selectedPersonId);
              if (active) {
                renderDetail(active);
              }
            }
          },
          (error) => {
            console.error("Realtime submissions subscription failed", error);
          }
        );
      }

      function boot() {
        document.querySelectorAll(".nav-item").forEach((button) => {
          button.classList.add(...NAV_BASE_CLASSES, ...NAV_INACTIVE_CLASSES);
        });

        document.querySelectorAll(".badge").forEach((badge) => {
          badge.classList.add(
            "inline-flex",
            "min-w-[2.25rem]",
            "items-center",
            "justify-center",
            "rounded-full",
            "bg-slate-900",
            "px-2.5",
            "py-1",
            "text-xs",
            "font-semibold",
            "text-white",
            "shadow-sm"
          );
        });

        syncSidebarToViewport();
        subscribeToPeople();
        subscribeToSubmissions();
        setActiveFilter(state.activeFilter);
        syncAdminControls();
      }

      window.addEventListener("beforeunload", () => {
        if (state.unsubscribe) state.unsubscribe();
        if (state.unsubscribeSubmissions) state.unsubscribeSubmissions();
      });

      async function connectPerson(learner, tutor) {
        if (!learner?.id || !tutor?.id) return;

        const mailSubject = encodeURIComponent("We found a match for you!  Slink");
        const mailBody = encodeURIComponent(
          [
            `Dear ${learner.name || "there"},`,
            "",
            "Great news! We have found a perfect match for your skill acquisition journey on Slink.",
            "",
            "Your Assigned Tutor Details:",
            `Name: ${tutor.name}`,
            `Email: ${tutor.email || "Not provided"}`,
            `Phone: ${tutor.phone || "Not provided"}`,
            "",
            "Please contact your tutor directly to begin your skill acquisition sessions. They are expecting your message!",
            "",
            "If you have any challenges or need further assistance, please feel free to get back to us by replying to this email.",
            "",
            "Best regards,",
            "The Slink Team",
            "https://slinkquest.vercel.app"
          ].join("\n")
        );

        const mailtoHref = `mailto:${encodeURIComponent(learner.email)}?subject=${mailSubject}&body=${mailBody}`;
        window.location.href = mailtoHref;

        try {
          await updateDoc(doc(registrationsRef, learner.id), {
            status: "connected",
            connectedTutorId: tutor.id,
            connectedTutorName: tutor.name,
            connectedTutorEmail: tutor.email || "",
            connectedTutorPhone: tutor.phone || "",
            connectedTutorLocation: tutor.location || "",
            connectedAt: serverTimestamp()
          });

          showToast(`Connected ${learner.name} to ${tutor.name}`, { tone: "success" });
        } catch (error) {
          console.error("Failed to update connection in database", error);
          showToast("Database update failed, but mail was opened.", { tone: "warning" });
          throw error;
        }
      }

      async function revertToPending(personId) {
        if (!personId) return;
        const personRef = doc(registrationsRef, personId);

        await updateDoc(personRef, {
          status: "pending",
          connectedTutorId: null,
          connectedTutorName: null,
          connectedTutorEmail: null,
          connectedTutorPhone: null,
          connectedTutorLocation: null,
          connectedAt: null,
          revertedAt: new Date()
        });
      }

      async function queueMatchEmails(learner, tutor) {
        if (!learner || !tutor) return;

        const overlappingSkills = learner.learnSkills
          ? tutor.teachSkills.filter((skill) =>
              learner.learnSkills.some(
                (desired) => desired && skill && desired.toLowerCase() === skill.toLowerCase()
              )
            )
          : [];

        const safeLearnerName = learner.name || "Slink learner";
        const safeTutorName = tutor.name || "Slink tutor";
        const learnerEmail = learner.email || "";
        const tutorEmail = tutor.email || "";

        const tutorContactBlock = [
          learner.email ? `Email: ${learner.email}` : null,
          learner.phone ? `Phone: ${learner.phone}` : null,
          learner.location ? `Location: ${learner.location}` : null
        ]
          .filter(Boolean)
          .join("\n");

        const tutorMessage = `Hi ${safeTutorName},\n\nYou have been matched with ${safeLearnerName} to teach ${
          overlappingSkills.length ? overlappingSkills.join(", ") : learner.learnSkills?.join(", ") || "a new skill"
        }.\n\nLearner details:\n${tutorContactBlock || "We will follow up with more details soon."}\n\nThank you for supporting the Slink community!`;

        const learnerContactBlock = [
          tutor.email ? `Email: ${tutor.email}` : null,
          tutor.phone ? `Phone: ${tutor.phone}` : null,
          tutor.location ? `Location: ${tutor.location}` : null
        ]
          .filter(Boolean)
          .join("\n");

        const learnerMessage = `Hi ${safeLearnerName},\n\nGreat news! ${safeTutorName} is available to help you with ${
          overlappingSkills.length ? overlappingSkills.join(", ") : learner.learnSkills?.join(", ") || "your goal"
        }.\n\nTutor details:\n${learnerContactBlock || "We will follow up with contact details shortly."}\n\nKeep learning with Slink!`;

        const notifications = [];

        if (tutorEmail) {
          notifications.push(
            addDoc(emailQueueRef, {
              to: tutorEmail,
              from: SENDER_EMAIL,
              subject: `New Slink learner match: ${safeLearnerName}`,
              message: {
                text: tutorMessage
              },
              metadata: {
                type: "tutorMatch",
                learnerId: learner.id,
                tutorId: tutor.id,
                overlappingSkills
              },
              status: "queued",
              createdAt: serverTimestamp()
            })
          );
        }

        if (learnerEmail) {
          notifications.push(
            addDoc(emailQueueRef, {
              to: learnerEmail,
              from: SENDER_EMAIL,
              subject: `Your Slink tutor match: ${safeTutorName}`,
              message: {
                text: learnerMessage
              },
              metadata: {
                type: "learnerMatch",
                learnerId: learner.id,
                tutorId: tutor.id,
                overlappingSkills
              },
              status: "queued",
              createdAt: serverTimestamp()
            })
          );
        }

        if (!notifications.length) {
          state.lastNotifiedTutorId = tutor.id;
          renderSelectedTutor(tutor);
          return;
        }

        await Promise.all(notifications);
        state.lastNotifiedTutorId = tutor.id;
        renderSelectedTutor(tutor);
      }

      function keepPending(personId) {
        if (!personId) return;
        // No Firestore update; just close the panel and keep status.
        console.info(`User ${personId} remains pending.`);
      }

      function renderDetail(person) {
        state.selectedPersonId = person.id;
        state.selectedPerson = person;
        const connectedTutor =
          person.status === "connected" && person.connectedTutorId
            ? state.people.find((candidate) => candidate.id === person.connectedTutorId) || null
            : null;
        state.selectedTutorId = connectedTutor ? connectedTutor.id : null;
        state.selectedTutor = connectedTutor;
        state.lastNotifiedTutorId = null;

        const fallbackTutor = connectedTutor ||
          (person.status === "connected" && person.connectedTutorId
            ? {
                id: person.connectedTutorId,
                name: person.connectedTutorName || "Assigned tutor",
                email: person.connectedTutorEmail || "",
                phone: person.connectedTutorPhone || "",
                location: person.connectedTutorLocation || ""
              }
            : null);

        renderSelectedTutor(fallbackTutor);

        const statusClasses = getStatusPillClasses(person.status)
          .replace("bg-emerald-50", "bg-emerald-50 text-emerald-700")
          .replace("bg-amber-50", "bg-amber-50 text-amber-700");

        detailStatus.className = statusClasses;
        detailStatus.innerHTML = `<span class="h-2 w-2 rounded-full ${
          person.status === "connected" ? "bg-emerald-500" : "bg-amber-500"
        }"></span><span class="capitalize">${person.status}</span>`;

        const safeName = person.name?.trim() || "Candidate";
        const registrationCode = person.id || "0000";
        detailName.textContent = person.name;

        const mailSubject = encodeURIComponent("Complete Your Professional Assessment");
        const mailBody = encodeURIComponent(
          [
            `Dear ${safeName},`,
            "",
            "Thank you for registering with Slink. We are pleased to have you move forward in our selection process.",
            "",
            "To better understand your skills and expertise, the next step is to complete a mandatory Professional Assessment. This test is designed to evaluate your proficiency and ensure a great fit for our current opportunities.",
            "",
            "Assessment Details",
            `Verification Code: ${registrationCode}`,
            "",
            "Access Link: https://slinkquest.vercel.app",
            "",
            "Instructions for Completion",
            "Click the link above to access the secure testing portal.",
            `When prompted, enter your unique verification code: ${registrationCode}.`,
            "Ensure you are in a quiet environment with a stable internet connection before beginning.",
            "The assessment should take approximately [Number] minutes to complete.",
            "",
            "Please ensure you complete this step by [Date/Time] to keep your application active. If you encounter any technical difficulties, please reply to this email, and our support team will assist you.",
            "",
            "We look forward to reviewing your results.",
            "",
            "Best regards,",
            "",
            "The Slink Talent Team",
            "Slink  https://slinkquest.vercel.app",
            "Email: skillbank0@gmail.com"
          ].join("\n")
        );

        const learnerMailHref = person.email
          ? `mailto:${encodeURIComponent(person.email)}?subject=${mailSubject}&body=${mailBody}`
          : "";

        detailEmail.innerHTML = person.email
          ? `<svg class="h-4 w-4 text-slate-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M4.5 6.75l7.5 4.5 7.5-4.5"/><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M3.75 6.75v10.5a1.5 1.5 0 012.25 1.5h13.5a1.5 1.5 0 011.5-1.5V6.75"/></svg><a class="underline decoration-dotted underline-offset-2 text-slate-600 hover:text-slate-900" href="${learnerMailHref}">${person.email}</a>`
          : "";
        detailPhone.innerHTML = person.phone
          ? `<svg class="h-4 w-4 text-slate-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M2.25 5.25a2.25 2.25 0 012.25-2.25h1.5c.473 0 .93.168 1.29.476l2.385 1.988a1.5 1.5 0 01.495 1.112v2.351a1.5 1.5 0 01-.44 1.06l-.877.877a.75.75 0 00-.073.974 10.45 10.45 0 003.799 3.798.75.75 0 00.974-.073l.877-.877a1.5 1.5 0 011.06-.44h2.351a1.5 1.5 0 011.112.495l1.988 2.385c.308.36.476.817.476 1.29v1.5A2.25 2.25 0 0118.75 21h-.5C9.335 21 2.5 14.165 2.5 5.75v-.5z"/></svg>${person.phone}`
          : "";
        const resume = person.resume ?? {
          url: "",
          status: "",
          submitted: Boolean(person.readyForLinking),
          ready: Boolean(person.readyForLinking),
          updatedAtLabel: ""
        };

        if (detailResumeChip) {
          detailResumeChip.innerHTML = resume.ready
            ? `<span class="inline-flex items-center gap-1 rounded-full bg-emerald-50 px-2.5 py-1 text-xs font-semibold text-emerald-700"><svg xmlns="http://www.w3.org/2000/svg" class="h-3.5 w-3.5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M4.5 12.75l6 6 9-13.5" /></svg>Ready to link</span>`
            : resume.submitted
            ? `<span class="inline-flex items-center gap-1 rounded-full bg-amber-50 px-2.5 py-1 text-xs font-semibold text-amber-700"><svg xmlns="http://www.w3.org/2000/svg" class="h-3.5 w-3.5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M3 6.75h13.5a2.25 2.25 0 012.25 2.25v8.25a2.25 2.25 0 01-2.25 2.25H6a3 3 0 01-3-3V6.75Z" /><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M9 3.75v3" /></svg>Resume submitted</span>`
            : "";
        }
        detailLocation.innerHTML = person.location
          ? `<svg class="h-4 w-4 text-slate-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M12 21.75c-4.5-5.25-6.75-8.625-6.75-11.25a6.75 6.75 0 1113.5 0c0 2.625-2.25 6-6.75 11.25Z"/><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M12 12.75a2.25 2.25 0 100-4.5 2.25 2.25 0 000 4.5Z"/></svg>${person.location}`
          : "";
        if (detailConnected) {
          if (person.status === "connected") {
            const connectedTutorName = fallbackTutor?.name || "Assigned tutor";
            const connectedTutorLocation = fallbackTutor?.location || "";
            const connectedIcon =
              '<svg class="h-4 w-4 text-emerald-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M13.5 6h2.25A2.25 2.25 0 0118 8.25v2.25M10.5 18H8.25A2.25 2.25 0 016 15.75V13.5M17.25 6.75 6.75 17.25" /></svg>';
            const connectedLabel = connectedTutorName && connectedTutorName !== "Assigned tutor"
              ? `Connected to <span class="font-medium text-slate-700">${connectedTutorName}</span>`
              : "Connected";
            const locationLabel = connectedTutorLocation
              ? `  ${connectedTutorLocation}`
              : "";
            detailConnected.innerHTML = `${connectedIcon}${connectedLabel}${locationLabel}`;
          } else {
            detailConnected.innerHTML = "";
          }
        }
        detailCreated.innerHTML = person.createdAtLabel
          ? `<svg class=\"h-4 w-4 text-slate-400\" xmlns=\"http://www.w3.org/2000/svg\" fill=\"none\" viewBox=\"0 0 24 24\" stroke=\"currentColor\"><path stroke-linecap=\"round\" stroke-linejoin=\"round\" stroke-width=\"1.5\" d=\"M6.75 3.75v2.25M17.25 3.75v2.25M3.75 9h16.5M5.25 6h13.5a1.5 1.5 0 011.5 1.5v11.25a1.5 1.5 0 01-1.5 1.5H5.25a1.5 1.5 0 01-1.5-1.5V7.5A1.5 1.5 0 015.25 6Zm0 6h4.5v4.5H5.25V12Z\"/></svg>${person.createdAtLabel}`
          : "";

        if (detailEmailValue) {
          detailEmailValue.innerHTML = person.email
            ? `<a class="break-words text-slate-600 underline decoration-dotted underline-offset-2 hover:text-slate-900" href="${learnerMailHref}">${person.email}</a>`
            : "";
        }
        if (detailRegistrationId) {
          detailRegistrationId.textContent = person.id || "";
        }
        if (detailResumeValue) {
          const resumeMeta = [resume.status, resume.updatedAtLabel ? `Updated ${resume.updatedAtLabel}` : ""]
            .filter(Boolean)
            .join("  ");
          detailResumeValue.innerHTML = resume.url
            ? `<a class="inline-flex items-center gap-2 text-slate-600 underline decoration-dotted underline-offset-2" href="${resume.url}" target="_blank" rel="noopener">View resume</a>$${resumeMeta ? `<span class="mt-1 block text-xs text-slate-400">${resumeMeta}</span>` : ""}`
            : '<span class="text-slate-400">No resume submitted.</span>';
        }
        if (detailReadyValue) {
          detailReadyValue.innerHTML = resume.ready
            ? `<span class="inline-flex items-center gap-2 text-emerald-600"><svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M4.5 12.75l6 6 9-13.5" /></svg>Ready for linking</span>`
            : resume.submitted
            ? `<span class="inline-flex items-center gap-2 text-amber-600"><svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M3 6.75h13.5a2.25 2.25 0 012.25 2.25v8.25a2.25 2.25 0 01-2.25 2.25H6a3 3 0 01-3-3V6.75Z" /><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M9 3.75v3" /></svg>Awaiting review</span>`
            : `<span class="inline-flex items-center gap-2 text-slate-500"><svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M6 18 18 6m0 12L6 6" /></svg>Not submitted</span>`;
        }
        if (detailSkillTestValue) {
          detailSkillTestValue.innerHTML = getSkillTestBadge(person.skillTest, { variant: "detail" });
        }
        if (detailProfessionalValue) {
          detailProfessionalValue.innerHTML = person.isProfessional
            ? `<span class="inline-flex items-center gap-2 text-emerald-600"><svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M9 12h6m-6 4h6M8.25 6h7.5M6 6h.008v.008H6V6z" /></svg>Professional profile</span>`
            : `<span class="inline-flex items-center gap-2 text-slate-500"><svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M4.5 19.5a8.25 8.25 0 0115 0" /></svg>Not flagged</span>`;
        }
        detailPhoneValue.innerHTML = person.phone
          ? `<a class="text-slate-600 underline decoration-dotted underline-offset-2" href="tel:${person.phone}">${person.phone}</a>`
          : "";
        detailLocationValue.textContent = person.location || "";
        detailSource.textContent = person.source || "";
        detailConsent.textContent =
          typeof person.consent === "boolean"
            ? person.consent
              ? "Granted"
              : "Revoked"
            : "Unknown";

        detailLearn.innerHTML = person.learnSkills.length
          ? person.learnSkills
              .map(
                (skill) =>
                  `<span class="inline-flex items-center rounded-full border border-slate-200 bg-slate-50 px-3 py-1 text-xs font-medium text-slate-600">${skill}</span>`
              )
              .join("")
          : '<span class="text-xs text-slate-400">No learning goals recorded.</span>';

        detailTeach.innerHTML = person.teachSkills.length
          ? person.teachSkills
              .map(
                (skill) =>
                  `<span class="inline-flex items-center rounded-full border border-emerald-200 bg-emerald-50 px-3 py-1 text-xs font-medium text-emerald-700">${skill}</span>`
              )
              .join("")
          : '<span class="text-xs text-slate-400">No teaching skills supplied.</span>';

        const matches = getTutorMatches(person);
        const hasMatches = matches.length > 0;

        detailMatchCount.textContent = hasMatches
          ? `${matches.length} match${matches.length > 1 ? "es" : ""}`
          : "No matches yet";

        detailTutorSuggestions.innerHTML = hasMatches
          ? matches
              .map(
                ({ tutor, overlapping }) => `
                  <div class="rounded-2xl border border-slate-200 bg-slate-50 px-4 py-3">
                    <div class="flex items-start justify-between gap-3">
                      <div>
                        <p class="text-sm font-semibold text-slate-900">${tutor.name}</p>
                        <p class="text-xs text-slate-400">${[
                          tutor.email || "No email on file",
                          tutor.phone || "No phone on file"
                        ].join("  ")}</p>
                      </div>
                      <span class="inline-flex items-center gap-1 rounded-full bg-emerald-100 px-3 py-1 text-xs font-semibold text-emerald-700">
                        ${overlapping.join(", ")}
                      </span>
                    </div>
                    <p class="mt-2 text-xs text-slate-500">Location: ${tutor.location || ""}</p>
                    <button
                      class="mt-3 inline-flex items-center gap-2 rounded-full border border-slate-300 bg-white px-3 py-1.5 text-xs font-semibold text-slate-600 transition hover:border-slate-400 hover:text-slate-900"
                      data-select-tutor="${tutor.id}"
                    >
                      <svg xmlns="http://www.w3.org/2000/svg" class="h-3.5 w-3.5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M4.5 12.75l6 6 9-13.5" />
                      </svg>
                      Choose as Tutor
                    </button>
                  </div>
                `
              )
              .join("")
          : '<p class="text-xs text-slate-400">No suitable tutor found yet. Encourage verified members to share the skill.</p>';

        const defaultConnectLabel = `<svg xmlns=\"http://www.w3.org/2000/svg\" class=\"h-4 w-4\" fill=\"none\" viewBox=\"0 0 24 24\" stroke=\"currentColor\"><path stroke-linecap=\"round\" stroke-linejoin=\"round\" stroke-width=\"1.5\" d=\"M8.25 7.5h7.5m-7.5 4.5h3\" /><path stroke-linecap=\"round\" stroke-linejoin=\"round\" stroke-width=\"1.5\" d=\"M3.75 6.75v10.5a1.5 1.5 0 012.25 1.5h13.5a1.5 1.5 0 011.5-1.5V6.75\" /></svg>Mark as Connected`;
        const keepPendingText = "Keep Pending";
        const keepPendingProgressText = "Keeping Pending...";
        const revertText = "Revert to Pending";
        const revertProgressText = "Reverting...";

        const updateConnectState = () => {
          const hasSelection = Boolean(state.selectedTutorId);
          connectButton.dataset.selectedTutorId = hasSelection ? state.selectedTutorId : "";
          connectButton.disabled = !hasSelection;
          if (!hasMatches) {
            connectButton.disabled = true;
          }
          connectButton.classList.toggle("bg-slate-900", !hasSelection);
          connectButton.classList.toggle("hover:bg-slate-700", !hasSelection);
          connectButton.classList.toggle("bg-emerald-600", hasSelection);
          connectButton.classList.toggle("hover:bg-emerald-700", hasSelection);
          connectButton.innerHTML = hasSelection
            ? `<svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M4.5 12.75l6 6 9-13.5" /></svg>Connect ${(person.name || "learner").split(/\s+/)[0]} to tutor`
            : defaultConnectLabel;
        };

        updateConnectState();

        detailTutorSuggestions.querySelectorAll("[data-select-tutor]").forEach((button) => {
          button.addEventListener("click", () => {
            state.selectedTutorId = button.dataset.selectTutor;
            const selectedTutor = state.people.find((candidate) => candidate.id === state.selectedTutorId) || null;
            state.selectedTutor = selectedTutor;
            state.lastNotifiedTutorId = null;
            renderSelectedTutor(selectedTutor);

            detailTutorSuggestions.querySelectorAll("[data-select-tutor]").forEach((other) => {
              other.classList.remove("border-slate-900", "text-slate-900", "bg-slate-900", "text-white");
              other.classList.add("border-slate-300", "text-slate-600", "bg-white");
            });
            button.classList.remove("border-slate-300", "text-slate-600", "bg-white");
            button.classList.add("border-slate-900", "text-white", "bg-slate-900");
            updateConnectState();
          });
        });

        declineButton.disabled = person.status !== "pending";
        const isConnected = person.status === "connected";
        declineButton.classList.toggle("border-red-200", !isConnected);
        declineButton.classList.toggle("bg-red-50", !isConnected);
        declineButton.classList.toggle("text-red-600", !isConnected);
        declineButton.classList.toggle("hover:border-red-300", !isConnected);
        declineButton.classList.toggle("hover:bg-red-100", !isConnected);
        declineButton.classList.toggle("border-slate-200", isConnected);
        declineButton.classList.toggle("bg-slate-50", isConnected);
        declineButton.classList.toggle("text-slate-600", isConnected);
        declineButton.classList.toggle("hover:border-slate-300", isConnected);
        declineButton.classList.toggle("hover:bg-slate-100", isConnected);

        const declineAction = isConnected ? revertToPending : keepPending;
        const declineLabelText = isConnected ? revertText : keepPendingText;
        const declineProgressText = isConnected ? revertProgressText : keepPendingProgressText;

        declineButton.disabled = false;
        declineButton.title = isConnected
          ? "Move this learner back to pending"
          : "Keep this learner pending";
        declineLabel.textContent = declineLabelText;

        connectButton.onclick = async () => {
          if (!state.selectedTutor || !state.selectedPerson) return;
          connectButton.disabled = true;
          connectButton.textContent = "Connecting...";
          try {
            await connectPerson(state.selectedPerson, state.selectedTutor);
            connectButton.textContent = "Notifying matches...";
            await queueMatchEmails(state.selectedPerson, state.selectedTutor);
            connectButton.textContent = "Connected";
            setTimeout(() => closeDetail(), 350);
          } catch (error) {
            console.error("Failed to connect person", error);
            connectButton.disabled = false;
            connectButton.textContent = "Failed. Try again";
          }
        };

        declineButton.onclick = async () => {
          if (!state.selectedPersonId) return;

          declineButton.disabled = true;
          declineLabel.textContent = declineProgressText;
          try {
            await declineAction(state.selectedPersonId);
            setTimeout(() => {
              declineLabel.textContent = declineLabelText;
              closeDetail();
            }, 200);
          } catch (error) {
            console.error("Failed to update learner status", error);
            declineButton.disabled = false;
            declineLabel.textContent = declineLabelText;
          }
        };
      }

      function openDetail(person) {
        if (!detailRoot || !detailOverlay || !detailPanel) return;

        renderDetail(person);

        if (body) {
          body.classList.add("overflow-hidden", "lg:overflow-visible");
        }

        detailOverlay.classList.add("opacity-0");
        detailOverlay.classList.remove("opacity-100");
        detailPanel.classList.add("translate-x-full");

        detailRoot.classList.remove("hidden");

        requestAnimationFrame(() => {
          detailOverlay.classList.remove("opacity-0");
          detailOverlay.classList.add("opacity-100");
          detailPanel.classList.remove("translate-x-full");
        });
      }

      function closeDetail() {
        if (!detailRoot || !detailOverlay || !detailPanel) return;
        if (detailRoot.classList.contains("hidden")) return;

        if (body) {
          body.classList.remove("overflow-hidden", "lg:overflow-visible");
        }

        state.selectedPersonId = null;
        state.selectedPerson = null;
        state.selectedTutorId = null;
        state.selectedTutor = null;
        state.lastNotifiedTutorId = null;
        renderSelectedTutor(null);

        detailOverlay.classList.add("opacity-0");
        detailOverlay.classList.remove("opacity-100");
        detailPanel.classList.add("translate-x-full");

        setTimeout(() => {
          detailRoot.classList.add("hidden");
        }, 250);
      }

      function getTutorMatches(person) {
        if (!person.learnSkills.length) return [];

        const desired = new Set(person.learnSkills.map((skill) => skill.toLowerCase()));

        return state.people
          .filter((candidate) => candidate.id !== person.id)
          .map((candidate) => {
            const overlapping = candidate.teachSkills.filter((skill) =>
              desired.has(skill.toLowerCase())
            );
            return { tutor: candidate, overlapping };
          })
          .filter(({ overlapping }) => overlapping.length)
          .sort((a, b) => b.overlapping.length - a.overlapping.length);
      }

      function wireDetailDismiss()
      {
        detailCloseButtons = Array.from(
          document.querySelectorAll("[data-close-detail]")
        );

        detailCloseButtons.forEach((button) =>
          button.addEventListener("click", closeDetail)
        );

        if (detailRoot) {
          detailRoot.addEventListener("click", (event) => {
            if (event.target === detailRoot) {
              closeDetail();
            }
          });
        }
      }

      function wireRemoveConfirm() {
        if (!removeConfirmInput || !removeConfirmSubmit) return;

        const validate = () => {
          const typed = (removeConfirmInput.value || "").trim().toLowerCase();
          const target = (removeConfirmState.personName || "").trim().toLowerCase();
          removeConfirmSubmit.disabled = !typed || typed !== target;
        };

        removeConfirmInput.addEventListener("input", validate);

        if (removeConfirmCancel) {
          removeConfirmCancel.addEventListener("click", () => {
            closeRemoveConfirm();
          });
        }

        if (removeConfirmOverlay) {
          removeConfirmOverlay.addEventListener("click", (event) => {
            if (event.target === removeConfirmOverlay) {
              closeRemoveConfirm();
            }
          });
        }

        if (removeConfirmRoot) {
          removeConfirmRoot.addEventListener("keydown", (event) => {
            if (event.key === "Escape") {
              event.stopPropagation();
              closeRemoveConfirm();
            }
          });
        }

        removeConfirmSubmit.addEventListener("click", async () => {
          if (!removeConfirmState.personId) return;

          removeConfirmSubmit.disabled = true;
          removeConfirmSubmit.textContent = "Deleting";

          try {
            await removePerson(removeConfirmState.personId);
            showToast(
              `${removeConfirmState.personName || "Registration"} has been deleted from the database.`,
              { tone: "warning" }
            );
            closeRemoveConfirm();
          } catch (error) {
            console.error("Failed to delete person", error);
            showToast("Deletion failed. Please try again.", { tone: "error" });
            removeConfirmSubmit.disabled = false;
            removeConfirmSubmit.textContent = removeConfirmDefaultLabel;
            return;
          }
        });
      }

      function openRemoveConfirm(person) {
        if (!removeConfirmRoot || !removeConfirmDialog || !removeConfirmOverlay) return;

        removeConfirmState = {
          personId: person.id,
          personName: person.name
        };

        if (removeConfirmLabel) {
          removeConfirmLabel.textContent = person.name || "this registration";
        }
        if (removeConfirmName) {
          removeConfirmName.value = person.name || "";
        }
        if (removeConfirmInput) {
          removeConfirmInput.value = "";
          removeConfirmInput.placeholder = person.name
            ? `Type "${person.name}" to confirm`
            : "Type the registrant's name";
        }

        if (removeConfirmSubmit) {
          removeConfirmSubmit.disabled = true;
          removeConfirmSubmit.textContent = removeConfirmDefaultLabel;
        }

        removeConfirmRoot.classList.remove("hidden");

        requestAnimationFrame(() => {
          removeConfirmOverlay.classList.remove("opacity-0");
          removeConfirmOverlay.classList.add("opacity-100");
          removeConfirmDialog.classList.remove("opacity-0");
          removeConfirmDialog.classList.add("opacity-100");
        });

        setTimeout(() => removeConfirmInput?.focus({ preventScroll: true }), 50);
      }

      function closeRemoveConfirm() {
        if (!removeConfirmRoot || !removeConfirmDialog || !removeConfirmOverlay) return;

        removeConfirmOverlay.classList.add("opacity-0");
        removeConfirmOverlay.classList.remove("opacity-100");
        removeConfirmDialog.classList.add("opacity-0");
        removeConfirmDialog.classList.remove("opacity-100");

        if (removeConfirmSubmit) {
          removeConfirmSubmit.textContent = removeConfirmDefaultLabel;
          removeConfirmSubmit.disabled = true;
        }
        if (removeConfirmInput) {
          removeConfirmInput.value = "";
        }

        setTimeout(() => {
          removeConfirmRoot.classList.add("hidden");
          removeConfirmState = { personId: null, personName: "" };
        }, 200);
      }

      wireDetailDismiss();
      wireRemoveConfirm();

      boot();
    </script>
  </body>
</html>
